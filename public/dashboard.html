<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Dashboard - Global Payments</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/public/css/dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üìä Transaction Dashboard</h1>
            <p>Monitor and analyze your Global Payments transactions</p>
            <div class="header-actions">
                <a href="/" class="btn btn-secondary">üè† Home</a>
                <a href="/public/card-verification.html" class="btn btn-secondary">üîê Verification</a>
                <a href="/public/payment.html" class="btn btn-secondary">üí≥ Payment</a>
                <button class="btn btn-primary" onclick="refreshTransactions()">üîÑ Refresh</button>
            </div>
        </div>

        <div class="filters">
            <h3>Filter Transactions</h3>
            <div class="quick-dates">
                <button class="btn btn-outline" onclick="dashboard.setDateRange('today')">Today</button>
                <button class="btn btn-outline" onclick="dashboard.setDateRange('week')">Last 7 Days</button>
                <button class="btn btn-outline" onclick="dashboard.setDateRange('month')">Last 30 Days</button>
                <button class="btn btn-outline" onclick="dashboard.clearDateRange()">All Time</button>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="start-date">Start Date</label>
                    <input type="date" id="start-date" value="">
                </div>
                <div class="filter-group">
                    <label for="end-date">End Date</label>
                    <input type="date" id="end-date" value="">
                </div>
                <div class="filter-group">
                    <label for="status-filter">Status</label>
                    <select id="status-filter">
                        <option value="">All Statuses</option>
                        <option value="approved">Approved</option>
                        <option value="declined">Declined</option>
                        <option value="error">Error</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="total-transactions">-</h3>
                <p>Total Transactions</p>
            </div>
            <div class="stat-card">
                <h3 id="approved-transactions">-</h3>
                <p>Approved</p>
            </div>
            <div class="stat-card">
                <h3 id="declined-transactions">-</h3>
                <p>Declined</p>
            </div>
            <div class="stat-card success-rate">
                <h3 id="success-rate">-</h3>
                <p>Success Rate</p>
            </div>
        </div>

        <div class="transactions-table">
            <div class="table-header">
                <h3>Recent Transactions</h3>
                <div class="table-controls">
                    <div class="export-section">
                        <button class="btn btn-export" onclick="dashboard.exportTransactions()" title="Export filtered transactions to CSV">
                            <span class="export-icon">üìä</span>
                            <span class="export-text">Export CSV</span>
                            <span class="export-count" id="export-count">(0)</span>
                        </button>
                    </div>
                    <input type="text" class="search-input" placeholder="Search transactions..." 
                           id="search-input" onkeyup="searchTransactions()">
                </div>
            </div>
            
            <div class="table-responsive">
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Type</th>
                            <th>Date & Time</th>
                            <th>Status</th>
                            <th>Amount</th>
                            <th>Card</th>
                            <th>Response</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- Transactions will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination">
                <!-- Pagination controls will be generated here -->
            </div>
        </div>
    </div>

    <script>
        class TransactionDashboard {
            constructor() {
                this.currentPage = 1;
                this.itemsPerPage = 25;
                this.allTransactions = [];
                this.filteredTransactions = [];
                this.init();
            }

            async init() {
                this.setDefaultDates();
                await this.loadTransactions();
                this.setupEventListeners();
            }

            setDefaultDates() {
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
            }

            setupEventListeners() {
                // Auto-apply filters when values change
                document.getElementById('status-filter').addEventListener('change', () => this.applyFilters());
                document.getElementById('start-date').addEventListener('change', () => this.applyFilters());
                document.getElementById('end-date').addEventListener('change', () => this.applyFilters());
            }

            async loadTransactions() {
                try {
                    this.showLoading();
                    
                    const response = await fetch('/api/transactions');
                    const data = await response.json();

                    if (data.success) {
                        this.allTransactions = data.transactions || [];
                        this.filteredTransactions = [...this.allTransactions];
                        this.updateStats();
                        this.renderTransactions();
                    } else {
                        this.showApiError(data.message || 'Failed to load transactions');
                    }
                } catch (error) {
                    this.showError('Failed to load transactions: ' + error.message);
                }
            }

            showLoading() {
                const tbody = document.getElementById('transactions-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="loading">
                            <div class="spinner"></div>
                            <p>Loading transactions...</p>
                        </td>
                    </tr>
                `;
            }

            showError(message) {
                const tbody = document.getElementById('transactions-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="error">
                            <strong>Error:</strong> ${message}
                        </td>
                    </tr>
                `;
            }

            showApiError(message) {
                const existingNotice = document.getElementById('api-error-notice');
                if (existingNotice) {
                    existingNotice.remove();
                }

                const notice = document.createElement('div');
                notice.id = 'api-error-notice';
                notice.style.cssText = `
                    background: linear-gradient(135deg, #f44336, #d32f2f);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    margin: 0 0 20px 0;
                    text-align: center;
                    font-weight: 500;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                notice.innerHTML = `
                    <span style="font-size: 1.1em;">‚ö†Ô∏è Unable to Load Transactions</span><br>
                    <span style="font-size: 0.9em; opacity: 0.9;">
                        ${message}. Dashboard functionality available when transactions are processed.
                    </span>
                `;

                const container = document.querySelector('.dashboard-container');
                const header = container.querySelector('.header');
                header.parentNode.insertBefore(notice, header.nextSibling);
            }

            updateStats() {
                const transactions = this.filteredTransactions;
                const approved = transactions.filter(t => t.status === 'approved').length;
                const declined = transactions.filter(t => t.status === 'declined').length;
                const successRate = transactions.length > 0 ? ((approved / transactions.length) * 100).toFixed(1) : 0;

                document.getElementById('total-transactions').textContent = transactions.length;
                document.getElementById('approved-transactions').textContent = approved;
                document.getElementById('declined-transactions').textContent = declined;
                document.getElementById('success-rate').textContent = successRate + '%';
                document.getElementById('export-count').textContent = `(${transactions.length})`;
            }

            renderTransactions() {
                const tbody = document.getElementById('transactions-body');
                
                if (this.filteredTransactions.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="empty-state">
                                <h3>No transactions found</h3>
                                <p>Perform card verifications or payments to see transactions here.</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const paginatedTransactions = this.filteredTransactions.slice(startIndex, endIndex);

                tbody.innerHTML = paginatedTransactions.map(transaction => `
                    <tr>
                        <td><strong>${transaction.id || 'N/A'}</strong></td>
                        <td>${this.getTransactionTypeBadge(transaction)}</td>
                        <td>${transaction.timestamp || 'N/A'}</td>
                        <td>
                            <span class="status-badge status-${transaction.status}">
                                ${transaction.status}
                            </span>
                        </td>
                        <td>${this.getAmountDisplay(transaction)}</td>
                        <td>
                            <div class="card-info">
                                <span class="card-type">${transaction.card?.type || 'N/A'}</span>
                                <span>${transaction.card?.last4 ? '****' + transaction.card.last4 : 'N/A'}</span>
                            </div>
                        </td>
                        <td>
                            <div class="response-info">
                                <strong style="font-family: monospace; color: var(--gp-blue);">
                                    ${transaction.response?.code || 'N/A'}
                                </strong>
                                <br>
                                <span style="color: var(--gp-gray); font-size: 0.85em;">
                                    ${(transaction.response?.message || 'N/A').substring(0, 35)}
                                </span>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="dashboard.viewDetails('${transaction.id}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                `).join('');

                this.renderPagination();
            }

            getTransactionTypeBadge(transaction) {
                if (transaction.type === 'verification') {
                    return '<span class="type-badge type-verification">üîê Verification</span>';
                } else if (transaction.type === 'payment') {
                    return '<span class="type-badge type-payment">üí≥ Payment</span>';
                } else {
                    return '<span class="type-badge type-unknown">‚ùì Unknown</span>';
                }
            }

            getAmountDisplay(transaction) {
                if (transaction.amount === 'VERIFY' || transaction.type === 'verification') {
                    return '<span class="verify-badge">VERIFY</span>';
                } else if (transaction.amount && transaction.amount !== '0.00') {
                    const amount = parseFloat(transaction.amount);
                    const currency = transaction.currency || 'USD';
                    return `<span class="amount-display">$${amount.toFixed(2)} ${currency}</span>`;
                } else {
                    return '<span class="amount-na">N/A</span>';
                }
            }

            renderPagination() {
                const totalPages = Math.ceil(this.filteredTransactions.length / this.itemsPerPage);
                const pagination = document.getElementById('pagination');
                
                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let paginationHTML = `
                    <button ${this.currentPage === 1 ? 'disabled' : ''} 
                            onclick="dashboard.goToPage(${this.currentPage - 1})">
                        Previous
                    </button>
                `;

                for (let i = 1; i <= totalPages; i++) {
                    if (i === this.currentPage || i === 1 || i === totalPages || 
                        (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                        paginationHTML += `
                            <button class="${i === this.currentPage ? 'active' : ''}" 
                                    onclick="dashboard.goToPage(${i})">
                                ${i}
                            </button>
                        `;
                    }
                }

                paginationHTML += `
                    <button ${this.currentPage === totalPages ? 'disabled' : ''} 
                            onclick="dashboard.goToPage(${this.currentPage + 1})">
                        Next
                    </button>
                `;

                pagination.innerHTML = paginationHTML;
            }

            goToPage(page) {
                this.currentPage = page;
                this.renderTransactions();
            }

            applyFilters() {
                const statusFilter = document.getElementById('status-filter').value;
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                this.filteredTransactions = this.allTransactions.filter(transaction => {
                    if (statusFilter && transaction.status !== statusFilter) {
                        return false;
                    }
                    
                    if (startDate && transaction.timestamp < startDate) {
                        return false;
                    }
                    
                    if (endDate && transaction.timestamp > endDate) {
                        return false;
                    }
                    
                    return true;
                });

                this.currentPage = 1;
                this.updateStats();
                this.renderTransactions();
            }

            viewDetails(transactionId) {
                alert('Transaction details view - TODO: implement modal');
            }

            exportTransactions() {
                if (this.filteredTransactions.length === 0) {
                    alert('No transactions to export');
                    return;
                }
                
                // Basic CSV export
                const csvData = this.convertToCSV(this.filteredTransactions);
                const blob = new Blob([csvData], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            convertToCSV(transactions) {
                const headers = ['ID', 'Type', 'Status', 'Amount', 'Currency', 'Card Type', 'Card Last4'];
                const rows = transactions.map(t => [
                    t.id || '',
                    t.type || '',
                    t.status || '',
                    t.amount || '',
                    t.currency || '',
                    t.card?.type || '',
                    t.card?.last4 || ''
                ]);
                
                return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            }

            setDateRange(range) {
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                const today = new Date();
                
                // Clear any existing active states
                document.querySelectorAll('.btn-outline').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active state to the clicked button
                event.target.classList.add('active');
                
                let startDate, endDate;
                
                switch(range) {
                    case 'today':
                        startDate = new Date(today);
                        endDate = new Date(today);
                        break;
                    case 'week':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 7);
                        endDate = new Date(today);
                        break;
                    case 'month':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 30);
                        endDate = new Date(today);
                        break;
                    default:
                        this.clearDateRange();
                        return;
                }
                
                // Format dates for input fields (YYYY-MM-DD)
                startDateInput.value = startDate.toISOString().split('T')[0];
                endDateInput.value = endDate.toISOString().split('T')[0];
                
                // Apply filters with new date range
                this.applyFilters();
            }

            clearDateRange() {
                // Clear date inputs
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
                
                // Clear any existing active states
                document.querySelectorAll('.btn-outline').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active state to "All Time" button
                event.target.classList.add('active');
                
                // Apply filters without date restriction
                this.applyFilters();
            }

            applyFilters() {
                const statusFilter = document.getElementById('status-filter').value;
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const searchTerm = document.getElementById('search-input')?.value?.toLowerCase() || '';

                this.filteredTransactions = this.allTransactions.filter(transaction => {
                    // Status filter
                    if (statusFilter && transaction.status !== statusFilter) {
                        return false;
                    }

                    // Date filter
                    if (startDate || endDate) {
                        const transactionDate = new Date(transaction.timestamp);
                        if (startDate && transactionDate < new Date(startDate)) {
                            return false;
                        }
                        if (endDate && transactionDate > new Date(endDate + 'T23:59:59')) {
                            return false;
                        }
                    }

                    // Search filter
                    if (searchTerm) {
                        const searchFields = [
                            transaction.id,
                            transaction.reference,
                            transaction.status,
                            transaction.type,
                            transaction.card?.brand,
                            transaction.card?.masked_number_last4
                        ].join(' ').toLowerCase();
                        
                        if (!searchFields.includes(searchTerm)) {
                            return false;
                        }
                    }

                    return true;
                });

                this.currentPage = 1; // Reset to first page when filtering
                this.updateStats();
                this.renderTransactions();
                this.renderPagination();
            }

            exportTransactions() {
                if (this.filteredTransactions.length === 0) {
                    alert('No transactions to export');
                    return;
                }
                
                const csv = this.convertToCSV(this.filteredTransactions);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            viewDetails(transactionId) {
                const transaction = this.allTransactions.find(t => t.id === transactionId);
                if (transaction) {
                    alert(`Transaction Details:\n\nID: ${transaction.id}\nStatus: ${transaction.status}\nAmount: ${transaction.amount} ${transaction.currency}\nType: ${transaction.type}`);
                }
            }

            goToPage(page) {
                this.currentPage = page;
                this.renderTransactions();
                this.renderPagination();
            }
        }

        // Global functions
        let dashboard;

        window.addEventListener('DOMContentLoaded', () => {
            dashboard = new TransactionDashboard();
        });

        function refreshTransactions() {
            if (dashboard) {
                dashboard.loadTransactions();
            }
        }

        function applyFilters() {
            if (dashboard) {
                dashboard.applyFilters();
            }
        }

        function searchTransactions() {
            if (dashboard) {
                dashboard.applyFilters();
            }
        }
    </script>
</body>
</html>