<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Dashboard - Global Payments</title>
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üìä Transaction Dashboard</h1>
            <p>Monitor and analyze your Global Payments transactions</p>
            <div class="header-actions">
                <a href="index.html" class="btn btn-secondary">üè† Home</a>
                <a href="card-verification.html" class="btn btn-secondary">üîê Verification</a>
                <a href="payment.html" class="btn btn-secondary">üí≥ Payment</a>
                <button class="btn btn-primary" onclick="refreshTransactions()">üîÑ Refresh</button>
            </div>
        </div>

        <div class="filters">
            <h3>Filter Transactions</h3>
            <div class="quick-dates">
                <button class="btn btn-outline" onclick="dashboard.setDateRange('today')">Today</button>
                <button class="btn btn-outline" onclick="dashboard.setDateRange('week')">Last 7 Days</button>
                <button class="btn btn-outline" onclick="dashboard.setDateRange('month')">Last 30 Days</button>
                <button class="btn btn-outline" onclick="dashboard.clearDateRange()">All Time</button>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="start-date">Start Date</label>
                    <input type="date" id="start-date" value="">
                </div>
                <div class="filter-group">
                    <label for="end-date">End Date</label>
                    <input type="date" id="end-date" value="">
                </div>
                <div class="filter-group">
                    <label for="status-filter">Status</label>
                    <select id="status-filter">
                        <option value="">All Statuses</option>
                        <option value="approved">Approved</option>
                        <option value="declined">Declined</option>
                        <option value="error">Error</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="total-transactions">-</h3>
                <p>Total Transactions</p>
            </div>
            <div class="stat-card">
                <h3 id="approved-transactions">-</h3>
                <p>Approved</p>
            </div>
            <div class="stat-card">
                <h3 id="declined-transactions">-</h3>
                <p>Declined</p>
            </div>
            <div class="stat-card success-rate">
                <h3 id="success-rate">-</h3>
                <p>Success Rate</p>
            </div>
        </div>

        <div class="transactions-table">
            <div class="table-header">
                <h3>Recent Transactions</h3>
                <div class="table-controls">
                    <div class="export-section">
                        <button class="btn btn-export" onclick="dashboard.exportTransactions()" title="Export filtered transactions to CSV">
                            <span class="export-icon">üìä</span>
                            <span class="export-text">Export CSV</span>
                            <span class="export-count" id="export-count">(0)</span>
                        </button>
                    </div>
                    <input type="text" class="search-input" placeholder="Search transactions..." 
                           id="search-input" onkeyup="searchTransactions()">
                </div>
            </div>
            
            <div class="table-responsive">
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Type</th>
                            <th>Date & Time</th>
                            <th>Status</th>
                            <th>Amount</th>
                            <th>Card</th>
                            <th>Response</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- Transactions will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination">
                <!-- Pagination controls will be generated here -->
            </div>
        </div>
    </div>

    <script>
        class TransactionDashboard {
            constructor() {
                this.currentPage = 1;
                this.itemsPerPage = 25;
                this.allTransactions = [];
                this.filteredTransactions = [];
                this.init();
            }

            async init() {
                this.setDefaultDates();
                await this.loadTransactions();
                this.setupEventListeners();
            }

            setDefaultDates() {
                // Don't set default dates - let the API use its optimized recent transaction logic
                // Users can set date filters manually if they need specific date ranges
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
            }

            setupEventListeners() {
                // Manual refresh only - no automatic refresh
            }

            async loadTransactions() {
                try {
                    this.showLoading();
                    
                    let url = '/api/transactions-api.php';
                    const params = new URLSearchParams();
                    
                    const startDate = document.getElementById('start-date').value;
                    const endDate = document.getElementById('end-date').value;
                    
                    // Only add date filters if user has specified them
                    if (startDate && endDate) {
                        params.append('start_date', startDate);
                        params.append('end_date', endDate);
                    }
                    
                    params.append('limit', '100');
                    // Add cache buster to prevent browser caching
                    params.append('_t', Date.now());
                    
                    if (params.toString()) {
                        url += '?' + params.toString();
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.success) {
                        this.allTransactions = data.data.transactions || [];
                        this.filteredTransactions = [...this.allTransactions];
                        this.updateStats();
                        this.renderTransactions();
                        
                        
                        // Remove any existing notices
                        const existingNotice = document.getElementById('demo-notice');
                        if (existingNotice) {
                            existingNotice.remove();
                        }
                    } else {
                        // Handle API errors - show proper error message
                        this.showApiError(data.message || 'Failed to load transactions');
                    }

                } catch (error) {
                    this.showError('Failed to load transactions: ' + error.message);
                }
            }

            showLoading() {
                const tbody = document.getElementById('transactions-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            <p>Loading transactions...</p>
                        </td>
                    </tr>
                `;
            }

            showError(message) {
                const tbody = document.getElementById('transactions-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="error">
                            <strong>Error:</strong> ${message}
                        </td>
                    </tr>
                `;
            }

            updateStats() {
                const transactions = this.filteredTransactions;
                const approved = transactions.filter(t => t.status === 'approved').length;
                const declined = transactions.filter(t => t.status === 'declined').length;
                const successRate = transactions.length > 0 ? Math.round((approved / transactions.length) * 100) : 0;

                document.getElementById('total-transactions').textContent = transactions.length;
                document.getElementById('approved-transactions').textContent = approved;
                document.getElementById('declined-transactions').textContent = declined;
                document.getElementById('success-rate').textContent = successRate + '%';
                
                // Update export count
                const exportCount = document.getElementById('export-count');
                if (exportCount) {
                    exportCount.textContent = `(${transactions.length})`;
                }
            }

            getTransactionTypeBadge(transaction) {
                const type = transaction.type || 'verification';
                
                if (type === 'payment') {
                    return '<span class="type-badge type-payment">üí≥ Payment</span>';
                } else if (type === 'verification') {
                    return '<span class="type-badge type-verification">üîê Verify</span>';
                } else {
                    return '<span class="type-badge type-unknown">‚ùì Unknown</span>';
                }
            }

            getAmountDisplay(transaction) {
                if (transaction.amount === 'VERIFY' || transaction.type === 'verification') {
                    return '<span class="verify-badge">VERIFY</span>';
                } else if (transaction.amount && transaction.amount !== '0.00') {
                    const amount = parseFloat(transaction.amount);
                    const currency = transaction.currency || 'USD';
                    return `<span class="amount-display">$${amount.toFixed(2)} ${currency}</span>`;
                } else {
                    return '<span class="amount-na">N/A</span>';
                }
            }

            renderTransactions() {
                const tbody = document.getElementById('transactions-body');
                
                if (this.filteredTransactions.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <h3>No transactions found</h3>
                                <p>Perform some card authentications using the <a href="index.html" style="color: var(--gp-blue);">authentication interface</a> to see transactions here.</p>
                                <p style="margin-top: 10px; font-size: 0.9em; color: var(--gp-gray);">
                                    Use Global Payments test cards from the <a href="https://developer.globalpay.com/resources/overview" target="_blank" style="color: var(--gp-blue);">developer documentation</a>.
                                </p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const paginatedTransactions = this.filteredTransactions.slice(startIndex, endIndex);

                tbody.innerHTML = paginatedTransactions.map(transaction => `
                    <tr>
                        <td>
                            <strong>${transaction.id || 'N/A'}</strong>
                        </td>
                        <td>
                            ${this.getTransactionTypeBadge(transaction)}
                        </td>
                        <td>
                            ${transaction.timestamp ? 
                                `<span title="${transaction.timestamp}" class="timestamp">${dashboard.formatExactTimestamp(transaction.timestamp)}</span>` : 
                                'N/A'
                            }
                        </td>
                        <td>
                            <span class="status-badge status-${transaction.status}">
                                ${transaction.status}
                            </span>
                        </td>
                        <td>
                            ${this.getAmountDisplay(transaction)}
                        </td>
                        <td>
                            <div class="card-info">
                                <span class="card-type">${transaction.card.type || 'N/A'}</span>
                                <span>****${transaction.card.last4 || 'N/A'}</span>
                            </div>
                        </td>
                        <td>
                            <div class="response-info">
                                <strong style="font-family: monospace; color: var(--gp-blue);">
                                    ${transaction.response.code || 'N/A'}
                                </strong>
                                <br>
                                <span style="color: var(--gp-gray); font-size: 0.85em;">
                                    ${(transaction.response.message || 'N/A').substring(0, 35)}${(transaction.response.message || '').length > 35 ? '...' : ''}
                                </span>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="dashboard.viewDetails('${transaction.id}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                `).join('');

                this.renderPagination();
            }

            renderPagination() {
                const totalPages = Math.ceil(this.filteredTransactions.length / this.itemsPerPage);
                const pagination = document.getElementById('pagination');
                
                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let paginationHTML = '';
                
                // Previous button
                paginationHTML += `
                    <button ${this.currentPage === 1 ? 'disabled' : ''} 
                            onclick="dashboard.goToPage(${this.currentPage - 1})">
                        Previous
                    </button>
                `;

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (i === this.currentPage || i === 1 || i === totalPages || 
                        (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                        paginationHTML += `
                            <button class="${i === this.currentPage ? 'active' : ''}" 
                                    onclick="dashboard.goToPage(${i})">
                                ${i}
                            </button>
                        `;
                    } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                        paginationHTML += '<span>...</span>';
                    }
                }

                // Next button
                paginationHTML += `
                    <button ${this.currentPage === totalPages ? 'disabled' : ''} 
                            onclick="dashboard.goToPage(${this.currentPage + 1})">
                        Next
                    </button>
                `;

                pagination.innerHTML = paginationHTML;
            }

            goToPage(page) {
                this.currentPage = page;
                this.renderTransactions();
            }

            applyFilters() {
                const statusFilter = document.getElementById('status-filter').value;
                
                this.filteredTransactions = this.allTransactions.filter(transaction => {
                    // Status filter
                    if (statusFilter && transaction.status !== statusFilter) {
                        return false;
                    }
                    
                    return true;
                });

                this.currentPage = 1;
                this.updateStats();
                this.renderTransactions();
                
                // Show filter applied indicator
                this.showFilterStatus();
            }

            searchTransactions() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
                
                if (!searchTerm) {
                    // If search is empty, show all transactions
                    this.filteredTransactions = [...this.allTransactions];
                } else {
                    this.filteredTransactions = this.allTransactions.filter(transaction => {
                        // Search in transaction ID (exact and partial match)
                        if (transaction.id && 
                            (transaction.id.toLowerCase() === searchTerm || 
                             transaction.id.toLowerCase().includes(searchTerm))) {
                            return true;
                        }
                        
                        // Search in reference number
                        if (transaction.reference && transaction.reference.toLowerCase().includes(searchTerm)) {
                            return true;
                        }
                        
                        // Search in card last4
                        if (transaction.card.last4 && transaction.card.last4.includes(searchTerm)) {
                            return true;
                        }
                        
                        // Search in response message
                        if (transaction.response.message && 
                            transaction.response.message.toLowerCase().includes(searchTerm)) {
                            return true;
                        }
                        
                        return false;
                    });
                }

                this.currentPage = 1;
                this.updateStats();
                this.renderTransactions();
            }

            showApiError(message) {
                // Remove any existing notices
                const existingNotice = document.getElementById('api-error-notice');
                if (existingNotice) {
                    existingNotice.remove();
                }

                const notice = document.createElement('div');
                notice.id = 'api-error-notice';
                notice.style.cssText = `
                    background: linear-gradient(135deg, #f44336, #d32f2f);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    margin: 0 0 20px 0;
                    text-align: center;
                    font-weight: 500;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                notice.innerHTML = `
                    <span style="font-size: 1.1em;">‚ö†Ô∏è Unable to Load Transactions</span><br>
                    <span style="font-size: 0.9em; opacity: 0.9;">
                        ${message}. Please ensure your Global Payments credentials are properly configured.
                    </span>
                `;

                const container = document.querySelector('.dashboard-container');
                const header = container.querySelector('.header');
                header.parentNode.insertBefore(notice, header.nextSibling);
            }


            async viewDetails(transactionId) {
                try {
                    const response = await fetch(`/api/transactions-api.php?transaction_id=${transactionId}`);
                    const data = await response.json();

                    if (data.success) {
                        const transaction = data.data;
                        this.showTransactionModal(transaction);
                    } else {
                        alert('Failed to load transaction details: ' + data.message);
                    }
                } catch (error) {
                    alert('Error loading transaction details: ' + error.message);
                }
            }

            showTransactionModal(transaction) {
                // Remove existing modal if any
                const existingModal = document.getElementById('transaction-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                const modal = document.createElement('div');
                modal.id = 'transaction-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                `;

                modal.innerHTML = `
                    <div style="
                        background: var(--gp-white);
                        border-radius: 16px;
                        padding: 30px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--gp-blue); font-size: 1.5rem;">Transaction Details</h3>
                            <button onclick="document.getElementById('transaction-modal').remove()" style="
                                background: none;
                                border: none;
                                font-size: 1.5rem;
                                cursor: pointer;
                                color: var(--gp-gray);
                                padding: 5px;
                            ">&times;</button>
                        </div>
                        
                        <div style="display: grid; gap: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; padding: 15px; background: var(--gp-light-gray); border-radius: 8px;">
                                <strong>Transaction ID:</strong>
                                <span style="font-family: monospace;">${transaction.id || 'N/A'}</span>
                                
                                <strong>Status:</strong>
                                <span class="status-badge status-${transaction.status}" style="display: inline-block; width: fit-content;">
                                    ${transaction.status}
                                </span>
                                
                                <strong>Amount:</strong>
                                <span style="font-size: 1.1em; font-weight: 600;">${transaction.amount === 'VERIFY' ? 'VERIFICATION' : (transaction.amount ? '$' + parseFloat(transaction.amount).toFixed(2) : 'N/A')}</span>
                                
                                <strong>Currency:</strong>
                                <span>${transaction.currency || 'USD'}</span>
                                
                                <strong>Date & Time:</strong>
                                <span>${transaction.timestamp ? this.formatExactTimestamp(transaction.timestamp) : 'N/A'}</span>
                                
                                <strong>Transaction Type:</strong>
                                <span style="text-transform: capitalize; font-weight: 600;">${transaction.type || 'N/A'}</span>
                                
                                <strong>Reference Number:</strong>
                                <span style="font-family: monospace;">${transaction.reference || 'N/A'}</span>
                                
                                <strong>Batch ID:</strong>
                                <span style="font-family: monospace;">${transaction.batch_id || 'N/A'}</span>
                            </div>
                            
                            <div style="padding: 15px; background: var(--gp-light-gray); border-radius: 8px;">
                                <h4 style="margin-bottom: 10px; color: var(--gp-black);">Card Information</h4>
                                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                                    <strong>Card Type:</strong>
                                    <span>${transaction.card.type || 'N/A'}</span>
                                    
                                    <strong>Card Number:</strong>
                                    <span style="font-family: monospace;">****${transaction.card.last4 || 'N/A'}</span>
                                    
                                    <strong>Expiry:</strong>
                                    <span>${transaction.card.exp_month || 'N/A'}/${transaction.card.exp_year || 'N/A'}</span>
                                </div>
                            </div>
                            
                            <div style="padding: 15px; background: var(--gp-light-gray); border-radius: 8px;">
                                <h4 style="margin-bottom: 10px; color: var(--gp-black);">Response Details</h4>
                                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                                    <strong>Response Code:</strong>
                                    <span style="font-family: monospace; background: var(--gp-white); padding: 2px 6px; border-radius: 4px;">${transaction.response.code || 'N/A'}</span>
                                    
                                    <strong>Response Message:</strong>
                                    <span>${transaction.response.message || 'N/A'}</span>
                                    
                                    <strong>Gateway Response Code:</strong>
                                    <span style="font-family: monospace; background: var(--gp-white); padding: 2px 6px; border-radius: 4px;">${transaction.gateway_response_code || 'N/A'}</span>
                                    
                                    <strong>Gateway Response Message:</strong>
                                    <span>${transaction.gateway_response_message || 'N/A'}</span>
                                </div>
                            </div>
                            
                            ${transaction.avs && (transaction.avs.code || transaction.avs.message) ? `
                                <div style="padding: 15px; background: var(--gp-light-gray); border-radius: 8px;">
                                    <h4 style="margin-bottom: 10px; color: var(--gp-black);">Address Verification (AVS)</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                                        <strong>AVS Code:</strong>
                                        <span style="font-family: monospace;">${transaction.avs.code || 'N/A'}</span>
                                        
                                        <strong>AVS Message:</strong>
                                        <span>${transaction.avs.message || 'N/A'}</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${transaction.cvv && (transaction.cvv.code || transaction.cvv.message) ? `
                                <div style="padding: 15px; background: var(--gp-light-gray); border-radius: 8px;">
                                    <h4 style="margin-bottom: 10px; color: var(--gp-black);">CVV Verification</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                                        <strong>CVV Code:</strong>
                                        <span style="font-family: monospace;">${transaction.cvv.code || 'N/A'}</span>
                                        
                                        <strong>CVV Message:</strong>
                                        <span>${transaction.cvv.message || 'N/A'}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="document.getElementById('transaction-modal').remove()" class="btn btn-primary">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            showFilterStatus() {
                const statusFilter = document.getElementById('status-filter').value;
                
                let filters = [];
                if (statusFilter) filters.push(`Status: ${statusFilter}`);
                
                // Remove existing filter status
                const existingStatus = document.getElementById('filter-status');
                if (existingStatus) {
                    existingStatus.remove();
                }
                
                if (filters.length > 0) {
                    const filterStatus = document.createElement('div');
                    filterStatus.id = 'filter-status';
                    filterStatus.style.cssText = `
                        background: var(--gp-blue);
                        color: white;
                        padding: 8px 15px;
                        border-radius: 6px;
                        margin: 10px 0;
                        font-size: 0.9em;
                        text-align: center;
                    `;
                    filterStatus.innerHTML = `
                        üîç Filters Applied: ${filters.join(' | ')} 
                        <button onclick="dashboard.clearFilters()" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            padding: 2px 8px;
                            border-radius: 4px;
                            margin-left: 10px;
                            cursor: pointer;
                            font-size: 0.8em;
                        ">Clear</button>
                    `;
                    
                    const tableHeader = document.querySelector('.table-header');
                    tableHeader.parentNode.insertBefore(filterStatus, tableHeader.nextSibling);
                }
            }

            clearFilters() {
                document.getElementById('status-filter').value = '';
                
                this.filteredTransactions = [...this.allTransactions];
                this.currentPage = 1;
                this.updateStats();
                this.renderTransactions();
                
                // Remove filter status
                const filterStatus = document.getElementById('filter-status');
                if (filterStatus) {
                    filterStatus.remove();
                }
            }

            setDateRange(range) {
                const today = new Date();
                const startDate = new Date();
                
                switch(range) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        startDate.setDate(today.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setDate(today.getDate() - 30);
                        break;
                }
                
                document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
                document.getElementById('end-date').value = today.toISOString().split('T')[0];
                this.loadTransactions();
            }

            clearDateRange() {
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
                this.loadTransactions();
            }

            formatExactTimestamp(timestamp) {
                try {
                    const date = new Date(timestamp);
                    
                    // Check if date is valid
                    if (isNaN(date.getTime())) {
                        return 'Invalid Date';
                    }
                    
                    // Format as: Jul 23, 2025 ‚Ä¢ 1:45:18 PM
                    const options = {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    };
                    
                    const formatted = date.toLocaleString('en-US', options);
                    return formatted.replace(' at', ' ‚Ä¢');
                } catch (error) {
                    console.error('Error formatting timestamp:', error);
                    return 'Invalid Date';
                }
            }

            exportTransactions() {
                if (this.filteredTransactions.length === 0) {
                    this.showExportMessage('No transactions to export', 'warning');
                    return;
                }

                try {
                    // Show loading state
                    this.showExportMessage('Preparing CSV export...', 'info');
                    
                    const csvData = this.convertToCSV(this.filteredTransactions);
                    const blob = new Blob([csvData], { 
                        type: 'text/csv;charset=utf-8;' 
                    });
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // Generate filename with timestamp and count
                    const timestamp = new Date().toISOString().split('T')[0];
                    const count = this.filteredTransactions.length;
                    a.download = `global_payments_transactions_${timestamp}_${count}_records.csv`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // Show success message
                    this.showExportMessage(`Successfully exported ${count} transactions`, 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    this.showExportMessage('Failed to export transactions. Please try again.', 'error');
                }
            }

            convertToCSV(transactions) {
                // Comprehensive headers for readable CSV
                const headers = [
                    'Transaction ID',
                    'Date & Time', 
                    'Transaction Type',
                    'Status',
                    'Amount (USD)',
                    'Currency',
                    'Card Type',
                    'Card Last 4 Digits',
                    'Response Code',
                    'Response Message',
                    'Reference Number',
                    'Gateway Response Code',
                    'Gateway Response Message',
                    'Batch ID',
                    'CVV Code',
                    'AVS Code'
                ];
                
                const rows = transactions.map(t => {
                    // Format amount properly
                    let amount = '';
                    if (t.amount === 'VERIFY') {
                        amount = 'VERIFICATION';
                    } else if (t.amount && !isNaN(parseFloat(t.amount))) {
                        amount = '$' + parseFloat(t.amount).toFixed(2);
                    } else {
                        amount = t.amount || 'N/A';
                    }
                    
                    // Format timestamp for readability
                    let formattedDate = '';
                    if (t.timestamp) {
                        try {
                            const date = new Date(t.timestamp);
                            formattedDate = date.toLocaleString('en-US', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true
                            });
                        } catch (e) {
                            formattedDate = t.timestamp;
                        }
                    }
                    
                    return [
                        t.id || 'N/A',
                        formattedDate || 'N/A',
                        (t.type || 'verification').toUpperCase(),
                        (t.status || 'Unknown').toUpperCase(),
                        amount,
                        t.currency || 'USD',
                        t.card.type || 'N/A',
                        t.card.last4 ? '****' + t.card.last4 : 'N/A',
                        t.response.code || 'N/A',
                        t.response.message || 'N/A',
                        t.reference || 'N/A',
                        t.gateway_response_code || 'N/A',
                        t.gateway_response_message || 'N/A',
                        t.batch_id || 'N/A',
                        t.cvv.code || 'N/A',
                        t.avs.code || 'N/A'
                    ].map(field => {
                        // Properly escape CSV fields
                        const stringField = String(field).replace(/"/g, '""');
                        return `"${stringField}"`;
                    });
                });
                
                // Add UTF-8 BOM for proper Excel compatibility
                const BOM = '\uFEFF';
                return BOM + [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            }


            showExportMessage(message, type = 'info') {
                // Remove existing message
                const existingMessage = document.getElementById('export-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                const messageEl = document.createElement('div');
                messageEl.id = 'export-message';
                
                const colors = {
                    success: { bg: '#10B981', border: '#059669' },
                    error: { bg: '#EF4444', border: '#DC2626' },
                    warning: { bg: '#F59E0B', border: '#D97706' },
                    info: { bg: '#262AFF', border: '#1B1EC6' }
                };
                
                const color = colors[type] || colors.info;
                
                messageEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${color.bg};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    border-left: 4px solid ${color.border};
                    font-size: 0.9rem;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    max-width: 300px;
                    animation: slideIn 0.3s ease;
                `;
                
                messageEl.textContent = message;
                document.body.appendChild(messageEl);
                
                // Auto remove after delay
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => messageEl.remove(), 300);
                    }
                }, type === 'info' ? 1500 : 3000);
            }
        }

        // Global functions
        let dashboard;

        window.addEventListener('DOMContentLoaded', () => {
            dashboard = new TransactionDashboard();
        });

        function refreshTransactions() {
            dashboard.loadTransactions();
        }

        function applyFilters() {
            dashboard.applyFilters();
        }

        function searchTransactions() {
            dashboard.searchTransactions();
        }
    </script>
</body>
</html>