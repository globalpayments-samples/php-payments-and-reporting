<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Authentication & Verification</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 0.3em;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .form-container {
            padding: 40px;
        }

        .mode-selector {
            margin-bottom: 30px;
        }

        .mode-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mode-toggle input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .mode-toggle label {
            display: block;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            text-align: center;
        }

        .mode-toggle input[type="radio"]:checked + label {
            border-color: #4285f4;
            background: #e8f0fe;
            color: #1a73e8;
        }

        .mode-toggle label strong {
            display: block;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .mode-toggle label small {
            color: #666;
            font-size: 0.9em;
        }

        .verification-type-selector {
            margin-bottom: 30px;
        }

        .verification-type-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .verification-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .verification-option {
            position: relative;
        }

        .verification-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .verification-option label {
            display: block;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .verification-option input[type="radio"]:checked + label {
            border-color: #4285f4;
            background: #e8f0fe;
            color: #1a73e8;
        }

        .verification-option label strong {
            display: block;
            margin-bottom: 5px;
        }

        .verification-option label small {
            color: #666;
            font-size: 0.9em;
        }

        .form-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .form-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .optional-sections {
            display: none;
        }

        .optional-sections.show {
            display: block;
        }

        #credit-card, #payment-credit-card, #verification-card-form, #payment-card-form {
            margin: 20px 0;
            padding: 0;
            border: none;
            border-radius: 8px;
            background: transparent;
            min-height: 200px;
            position: relative;
        }

        /* Fix payment form container height issue */
        #payment-globalpayments-form {
            min-height: 400px !important;
            height: auto !important;
        }

        /* Ensure payment form elements have proper dimensions */
        #payment-globalpayments-form .credit-card-card-number,
        #payment-globalpayments-form .credit-card-card-expiration,
        #payment-globalpayments-form .credit-card-card-cvv,
        #payment-globalpayments-form .credit-card-card-holder-name {
            margin-bottom: 15px !important;
            min-height: 50px !important;
        }

        #payment-globalpayments-form label {
            display: block !important;
            margin-bottom: 5px !important;
            font-weight: 500 !important;
            color: #333 !important;
        }

        #payment-globalpayments-form .credit-card-card-number-target,
        #payment-globalpayments-form .credit-card-card-expiration-target,
        #payment-globalpayments-form .credit-card-card-cvv-target,
        #payment-globalpayments-form .credit-card-card-holder-name-target {
            min-height: 40px !important;
            border: 1px solid #ddd !important;
            border-radius: 6px !important;
            padding: 10px !important;
            background: white !important;
        }

        #payment-globalpayments-form .credit-card-submit {
            margin-top: 20px !important;
            min-height: 50px !important;
        }

        #payment-globalpayments-form .credit-card-submit-target {
            min-height: 45px !important;
            background: #4285f4 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 12px 20px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            width: 100% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* Apply same fixes to verification form for consistency */
        #verification-globalpayments-form {
            min-height: 400px !important;
            height: auto !important;
        }

        #verification-globalpayments-form .credit-card-card-number,
        #verification-globalpayments-form .credit-card-card-expiration,
        #verification-globalpayments-form .credit-card-card-cvv,
        #verification-globalpayments-form .credit-card-card-holder-name {
            margin-bottom: 15px !important;
            min-height: 50px !important;
        }

        #verification-globalpayments-form .credit-card-card-number-target,
        #verification-globalpayments-form .credit-card-card-expiration-target,
        #verification-globalpayments-form .credit-card-card-cvv-target,
        #verification-globalpayments-form .credit-card-card-holder-name-target {
            min-height: 40px !important;
            border: 1px solid #ddd !important;
            border-radius: 6px !important;
            padding: 10px !important;
            background: white !important;
        }

        #verification-globalpayments-form .credit-card-submit-target {
            min-height: 45px !important;
            background: #4caf50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 12px 20px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            width: 100% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* Style the Global Payments form container */
        #verification-card-form, #payment-card-form {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Custom styles for Global Payments elements */
        .gp-form-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif !important;
        }
        
        /* Style the sandbox warning */
        .gp-sandbox-warning, [style*="background-color: rgb(139, 0, 0)"] {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%) !important;
            color: white !important;
            border-radius: 8px !important;
            padding: 12px 16px !important;
            margin-bottom: 20px !important;
            font-weight: 500 !important;
            text-align: center !important;
            border: none !important;
        }
        
        /* Style form sections */
        .gp-section-header {
            background: #f8f9fa;
            padding: 12px 16px;
            margin: -25px -25px 20px -25px;
            border-radius: 12px 12px 0 0;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Improve input field styling */
        .gp-field-container input, .gp-field-container select {
            border: 1px solid #ddd !important;
            border-radius: 6px !important;
            padding: 12px !important;
            font-size: 16px !important;
            transition: border-color 0.3s ease !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        .gp-field-container input:focus, .gp-field-container select:focus {
            outline: none !important;
            border-color: #4285f4 !important;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1) !important;
        }
        
        /* Style labels */
        .gp-field-container label {
            font-weight: 500 !important;
            color: #333 !important;
            margin-bottom: 6px !important;
            display: block !important;
        }
        
        /* Style the submit button */
        .gp-submit-button, [type="submit"] {
            background: linear-gradient(90deg, #4285f4 0%, #34a853 100%) !important;
            color: white !important;
            border: none !important;
            padding: 15px 30px !important;
            border-radius: 8px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            width: 100% !important;
            margin-top: 20px !important;
        }
        
        .gp-submit-button:hover, [type="submit"]:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3) !important;
        }

        .hpp-iframe {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 8px;
        }

        .hpp-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .hpp-button {
            background: linear-gradient(90deg, #4285f4 0%, #34a853 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .hpp-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }

        .hpp-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Card Form Styling */
        .card-form-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        .sandbox-warning {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
            border: none;
        }
        
        .card-form {
            margin: 0;
        }
        
        .card-form .form-group {
            margin-bottom: 20px;
        }
        
        .card-form .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .card-form .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .card-form label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .card-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        .card-form input:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }
        
        .card-form input::placeholder {
            color: #999;
        }
        
        .submit-button {
            background: linear-gradient(90deg, #4285f4 0%, #34a853 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
            font-family: inherit;
        }
        
        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }
        
        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .payment-button {
            background: linear-gradient(90deg, #4285f4 0%, #34a853 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .payment-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }

        .payment-note {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }

        .result {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .result.success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }

        .result.error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }

        .result-success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }

        .result-error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }

        .result-warning {
            background: #fff8e1;
            border: 1px solid #F59E0B;
            color: #92400E;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .result-icon {
            font-size: 1.5em;
        }

        .result-title {
            font-weight: 600;
            font-size: 1.2em;
        }

        .result-message {
            margin-bottom: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-panel {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-panel h4 {
            margin-bottom: 10px;
            color: #1976d2;
        }

        .info-panel ul {
            margin-left: 20px;
        }

        .info-panel li {
            margin-bottom: 5px;
            color: #424242;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .verification-options,
            .mode-toggle {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .form-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔐 Card Verification & Payment</h1>
            <p>Secure card verification and real transaction processing</p>
            <div style="margin-top: 15px;">
                <a href="dashboard.html" style="display: inline-block; padding: 10px 20px; background: #4285f4; color: white; text-decoration: none; border-radius: 8px; font-weight: 500; transition: background 0.3s ease;">
                    📊 View Transaction Dashboard
                </a>
            </div>
        </div>

        <div class="form-container">
            <div class="mode-selector">
                <div class="mode-toggle">
                    <input type="radio" id="auth-mode" name="operation_mode" value="authentication" checked>
                    <label for="auth-mode">
                        <strong>🔐 Card Validation</strong>
                        <small>Verification without charges</small>
                    </label>
                    
                    <input type="radio" id="payment-mode" name="operation_mode" value="payment">
                    <label for="payment-mode">
                        <strong>💳 Real Payment Testing</strong>
                        <small>Process actual Heartland transactions</small>
                    </label>
                </div>
            </div>

            <div class="info-panel" id="auth-info-panel">
                <h4>📋 What is Card Verification?</h4>
                <ul>
                    <li><strong>Basic:</strong> Validates card number and expiration</li>
                    <li><strong>AVS:</strong> Verifies billing address matches card</li>
                    <li><strong>CVV:</strong> Confirms security code on card</li>
                    <li><strong>Full:</strong> Complete verification with all checks</li>
                </ul>
            </div>

            <div class="info-panel" id="payment-info-panel" style="display: none;">
                <h4>💳 Real Payment Processing</h4>
                <ul>
                    <li><strong>Secure:</strong> PCI-compliant Heartland tokenization</li>
                    <li><strong>Real Charges:</strong> Actual transaction processing</li>
                    <li><strong>Test Cards:</strong> Use Heartland test cards</li>
                    <li><strong>Dashboard:</strong> View real transaction results</li>
                </ul>
            </div>

            <form id="verification-form">
                <div class="verification-type-selector">
                    <label>Choose Verification Type:</label>
                    <div class="verification-options">
                        <div class="verification-option">
                            <input type="radio" id="basic" name="verification_type" value="basic" checked>
                            <label for="basic">
                                <strong>Basic</strong>
                                <small>Card validation only</small>
                            </label>
                        </div>
                        <div class="verification-option">
                            <input type="radio" id="avs" name="verification_type" value="avs">
                            <label for="avs">
                                <strong>AVS Check</strong>
                                <small>Address verification</small>
                            </label>
                        </div>
                        <div class="verification-option">
                            <input type="radio" id="cvv" name="verification_type" value="cvv">
                            <label for="cvv">
                                <strong>CVV Check</strong>
                                <small>Security code validation</small>
                            </label>
                        </div>
                        <div class="verification-option">
                            <input type="radio" id="full" name="verification_type" value="full">
                            <label for="full">
                                <strong>Full Verification</strong>
                                <small>All checks combined</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="credit-card"></div>

                <div id="optional-sections" class="optional-sections">
                    <div class="form-section" id="billing-section">
                        <h3>📍 Billing Address (for AVS)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="street">Street Address</label>
                                <input type="text" id="street" name="street" placeholder="123 Main St">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="city">City</label>
                                <input type="text" id="city" name="city" placeholder="New York">
                            </div>
                            <div class="form-group">
                                <label for="state">State</label>
                                <input type="text" id="state" name="state" placeholder="NY" maxlength="2">
                            </div>
                            <div class="form-group">
                                <label for="postal_code">ZIP Code</label>
                                <input type="text" id="postal_code" name="postal_code" placeholder="12345">
                            </div>
                        </div>
                    </div>

                    <div class="form-section" id="customer-section">
                        <h3>👤 Customer Information (Optional)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customer_id">Customer ID</label>
                                <input type="text" id="customer_id" name="customer_id" placeholder="CUST_12345">
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" placeholder="customer@example.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phone">Phone</label>
                                <input type="tel" id="phone" name="phone" placeholder="(555) 123-4567">
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Payment Form for Heartland Integration -->
            <form id="payment-form" style="display: none;">
                <div class="form-section">
                    <h3>💳 Payment Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-amount">Amount (USD)</label>
                            <input type="number" id="payment-amount" name="payment-amount" placeholder="10.00" min="0.01" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="payment-currency">Currency</label>
                            <select id="payment-currency" name="payment-currency">
                                <option value="USD" selected>USD - US Dollar</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>💳 Card Information</h3>
                    <div id="payment-credit-card"></div>
                </div>

                <div class="form-section">
                    <h3>👤 Customer Information (Optional)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-customer-first-name">First Name</label>
                            <input type="text" id="payment-customer-first-name" name="payment-customer-first-name" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label for="payment-customer-last-name">Last Name</label>
                            <input type="text" id="payment-customer-last-name" name="payment-customer-last-name" placeholder="Doe">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-customer-email">Email</label>
                            <input type="email" id="payment-customer-email" name="payment-customer-email" placeholder="john.doe@example.com">
                        </div>
                        <div class="form-group">
                            <label for="payment-customer-phone">Phone</label>
                            <input type="tel" id="payment-customer-phone" name="payment-customer-phone" placeholder="(555) 123-4567">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>📍 Billing Address (Optional)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-billing-street">Street Address</label>
                            <input type="text" id="payment-billing-street" name="payment-billing-street" placeholder="123 Main St">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-billing-city">City</label>
                            <input type="text" id="payment-billing-city" name="payment-billing-city" placeholder="New York">
                        </div>
                        <div class="form-group">
                            <label for="payment-billing-state">State</label>
                            <input type="text" id="payment-billing-state" name="payment-billing-state" placeholder="NY" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label for="payment-billing-postal">ZIP Code</label>
                            <input type="text" id="payment-billing-postal" name="payment-billing-postal" placeholder="12345">
                        </div>
                    </div>
                </div>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing...</p>
            </div>

            <div class="result-container" id="result-container">
                <div id="result-content"></div>
            </div>
        </div>
    </div>

    <script src="https://js.globalpay.com/v1/globalpayments.js"></script>
    <script>
        class CardAuthenticator {
            constructor() {
                this.verificationForm = null;
                this.paymentForm = null;
                this.isInitialized = false;
                this.init();
            }

            async init() {
                try {
                    await this.ensureGlobalPaymentsReady();
                    await this.loadConfiguration();
                    this.setupEventListeners();
                    this.updateFormVisibility();
                    console.log('✅ Card authenticator initialized');
                } catch (error) {
                    this.showError('Failed to initialize payment form: ' + error.message);
                }
            }

            ensureGlobalPaymentsReady() {
                return new Promise((resolve, reject) => {
                    if (typeof GlobalPayments !== 'undefined') {
                        resolve();
                    } else {
                        let attempts = 0;
                        const checkInterval = setInterval(() => {
                            attempts++;
                            if (typeof GlobalPayments !== 'undefined') {
                                clearInterval(checkInterval);
                                resolve();
                            } else if (attempts >= 20) {
                                clearInterval(checkInterval);
                                reject(new Error('GlobalPayments SDK failed to load'));
                            }
                        }, 250);
                    }
                });
            }

            async loadConfiguration() {
                const response = await fetch('/config.php');
                if (!response.ok) {
                    throw new Error(`Configuration error: ${response.status}`);
                }
                
                const config = await response.json();
                if (!config.success) {
                    throw new Error('Invalid configuration response');
                }

                GlobalPayments.configure({
                    publicApiKey: config.data.publicApiKey
                });

                this.initializeForms();
            }

            initializeForms() {
                // Initialize verification form only when in verification mode
                this.initializeVerificationForm();
                this.isInitialized = true;
            }

            initializeVerificationForm() {
                const container = document.getElementById('credit-card');
                
                // Use GlobalPayments SDK with proper verification setup
                container.innerHTML = `
                    <div class="verification-info" style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                        <h4 style="color: #2e7d32; margin-bottom: 10px;">🔐 Secure Card Verification</h4>
                        <p style="margin: 0; color: #424242;">Secure verification using GlobalPayments tokenization. No charges will be made to your card.</p>
                    </div>
                    <div class="verification-hpp-container" style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                        <div class="sandbox-warning" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; font-weight: 500; text-align: center;">
                            🏠 Sandbox Mode: Use test card numbers only
                        </div>
                        <div id="verification-globalpayments-form"></div>
                    </div>
                `;

                // Initialize GlobalPayments SDK for verification
                this.setupVerificationGlobalPayments();
            }

            setupVerificationGlobalPayments() {
                try {
                    // Initialize GlobalPayments SDK for verification (no charge)
                    this.verificationForm = GlobalPayments.creditCard.form('#verification-globalpayments-form', { 
                        style: "gp-default",
                        amount: '0.00' // No charge for verification
                    });

                    this.verificationForm.on('token-success', (resp) => {
                        this.handleVerificationTokenSuccess(resp);
                    });

                    this.verificationForm.on('token-error', (error) => {
                        this.showError('Card tokenization failed: ' + error.message);
                        this.hideLoading();
                    });

                    this.verificationForm.ready(() => {
                        console.log('✅ Verification GlobalPayments form ready');
                    });
                } catch (error) {
                    console.error('Verification form setup failed:', error);
                    this.showError('Failed to initialize verification form: ' + error.message);
                }
            }




            initializePaymentForm() {
                // For real payments, use GlobalPayments SDK just like verification but with actual charge
                this.setupPaymentGlobalPayments();
            }

            setupPaymentGlobalPayments() {
                const container = document.getElementById('payment-credit-card');
                container.innerHTML = `
                    <div class="payment-info" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                        <h4 style="color: #1976d2; margin-bottom: 10px;">💳 Real Payment Processing</h4>
                        <p style="margin: 0; color: #424242;">Secure payment processing using GlobalPayments tokenization. Real charges will be made to your card.</p>
                    </div>
                    <div class="payment-hpp-container" style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                        <div class="sandbox-warning" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; font-weight: 500; text-align: center;">
                            💰 Live Payment Mode: Real charges will be processed
                        </div>
                        <div id="payment-amount-display" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-weight: bold;">
                            Please enter payment amount above
                        </div>
                        <div id="payment-globalpayments-form"></div>
                    </div>
                `;

                // Initialize the payment form immediately (like verification form)
                this.initializePaymentGlobalPaymentsFormBase();
                
                // Set up payment form that updates amount when entered
                this.setupPaymentAmountListener();
            }
            
            initializePaymentGlobalPaymentsFormBase() {
                try {
                    console.log('🚀 Initializing GlobalPayments payment form');
                    
                    // Initialize GlobalPayments SDK for payment with initial amount
                    this.paymentForm = GlobalPayments.creditCard.form('#payment-globalpayments-form', { 
                        style: "gp-default",
                        amount: '0.01' // Minimal amount to initialize form
                    });
                    
                    this.paymentForm.on('token-success', (resp) => {
                        console.log('✅ Payment token success:', resp);
                        // Get current amount from the display
                        const currentAmount = this.getCurrentPaymentAmount();
                        this.handlePaymentTokenSuccess(resp, currentAmount);
                    });
                    
                    this.paymentForm.on('token-error', (error) => {
                        console.error('❌ Payment token error:', error);
                        this.showError('Payment tokenization failed: ' + error.message);
                        this.hideLoading();
                    });
                    
                    this.paymentForm.ready(() => {
                        console.log('✅ Payment GlobalPayments form ready');
                    });
                    
                } catch (error) {
                    console.error('❌ Base payment form setup failed:', error);
                    this.showError('Failed to initialize payment form: ' + error.message);
                }
            }
            
            getCurrentPaymentAmount() {
                const amountField = document.getElementById('payment-amount');
                return parseFloat(amountField?.value || '0');
            }
            
            setupPaymentAmountListener() {
                const amountField = document.getElementById('payment-amount');
                const amountDisplay = document.getElementById('payment-amount-display');
                const formContainer = document.getElementById('payment-globalpayments-form');
                
                if (!amountField || !amountDisplay || !formContainer) {
                    console.error('❌ Payment form elements not found');
                    return;
                }
                
                let debounceTimer;
                
                // Listen for amount changes (form is already initialized)
                amountField.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    
                    const amount = parseFloat(amountField.value);
                    
                    if (!amount || amount <= 0) {
                        // Just update display
                        amountDisplay.innerHTML = 'Please enter payment amount above';
                        amountDisplay.style.color = '#666';
                        return;
                    }
                    
                    // Update display - form is already interactive
                    amountDisplay.innerHTML = `Payment Amount: $${amount.toFixed(2)} USD`;
                    amountDisplay.style.color = '#1976d2';
                    
                });
            }
            
            async handlePaymentTokenSuccess(tokenResponse, amount) {
                try {
                    this.showLoading('Processing payment...');
                    
                    const requestData = {
                        payment_token: tokenResponse.paymentReference,
                        amount: amount,
                        currency: document.getElementById('payment-currency').value || 'USD',
                        mode: 'payment'
                    };
                    
                    // Add customer information if provided
                    const firstName = document.getElementById('payment-customer-first-name')?.value;
                    const lastName = document.getElementById('payment-customer-last-name')?.value;
                    const email = document.getElementById('payment-customer-email')?.value;
                    const phone = document.getElementById('payment-customer-phone')?.value;
                    
                    if (firstName || lastName || email || phone) {
                        requestData.customer = {
                            first_name: firstName || '',
                            last_name: lastName || '',
                            email: email || '',
                            phone: phone || ''
                        };
                    }
                    
                    // Add billing address if provided
                    const street = document.getElementById('payment-billing-street')?.value;
                    const city = document.getElementById('payment-billing-city')?.value;
                    const state = document.getElementById('payment-billing-state')?.value;
                    const postal = document.getElementById('payment-billing-postal')?.value;
                    const country = document.getElementById('payment-billing-country')?.value;
                    
                    if (street || city || state || postal) {
                        requestData.billing_address = {
                            street: street || '',
                            city: city || '',
                            state: state || '',
                            postal_code: postal || '',
                            country: country || 'US'
                        };
                    }
                    
                    console.log('Processing payment with data:', requestData);
                    
                    // Process payment through heartland-process-payment.php
                    const response = await fetch('/heartland-process-payment.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    console.log('Payment result:', result);
                    
                    if (result.success) {
                        this.showPaymentSuccess(result);
                    } else {
                        this.showError('Payment failed: ' + (result.message || 'Unknown error'));
                    }
                    
                } catch (error) {
                    this.showError('Network error: ' + error.message);
                } finally {
                    this.hideLoading();
                }
            }
            
            showPaymentSuccess(responseData) {
                const container = document.getElementById('result-container');
                const content = document.getElementById('result-content');
                
                content.innerHTML = `
                    <h3>✅ Payment Successful</h3>
                    <p>Your payment has been processed successfully!</p>
                    <div style="margin-top: 15px; font-size: 0.9em;">
                        <strong>Transaction Details:</strong><br>
                        Transaction ID: ${responseData.transaction_id || 'N/A'}<br>
                        Amount: $${responseData.amount || 'N/A'} ${responseData.currency || 'USD'}<br>
                        Status: ${responseData.response_message || 'Approved'}<br>
                        Payment Method: ${responseData.card_type || 'N/A'} ending in ${responseData.last_four || 'N/A'}<br>
                        Authorization Code: ${responseData.auth_code || 'N/A'}
                    </div>
                `;
                
                container.className = 'result-container result-success';
                container.style.display = 'block';
                
                // Scroll to results
                container.scrollIntoView({ behavior: 'smooth' });
            }
            
            setupEventListeners() {
                // Operation mode change
                document.querySelectorAll('input[name="operation_mode"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.updateOperationMode();
                    });
                });

                // Verification type change
                document.querySelectorAll('input[name="verification_type"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.updateFormVisibility();
                    });
                });
            }

            updateOperationMode() {
                const operationMode = document.querySelector('input[name="operation_mode"]:checked').value;
                const authInfoPanel = document.getElementById('auth-info-panel');
                const paymentInfoPanel = document.getElementById('payment-info-panel');
                const verificationForm = document.getElementById('verification-form');
                const paymentForm = document.getElementById('payment-form');
                const resultContainer = document.getElementById('result-container');

                if (operationMode === 'authentication') {
                    // Show authentication UI
                    authInfoPanel.style.display = 'block';
                    paymentInfoPanel.style.display = 'none';
                    verificationForm.style.display = 'block';
                    paymentForm.style.display = 'none';
                    
                    // Initialize verification form when switching to auth mode
                    if (this.isInitialized) {
                        this.initializeVerificationForm();
                    }
                } else {
                    // Show payment UI
                    authInfoPanel.style.display = 'none';
                    paymentInfoPanel.style.display = 'block';
                    verificationForm.style.display = 'none';
                    paymentForm.style.display = 'block';
                    
                    // Initialize payment form when switching to payment mode
                    if (this.isInitialized) {
                        this.initializePaymentForm();
                    }
                }
                // Hide results when switching modes
                resultContainer.style.display = 'none';
            }

            updateFormVisibility() {
                const verificationType = document.querySelector('input[name="verification_type"]:checked').value;
                const optionalSections = document.getElementById('optional-sections');
                const billingSection = document.getElementById('billing-section');
                const customerSection = document.getElementById('customer-section');

                if (verificationType === 'basic') {
                    optionalSections.classList.remove('show');
                } else {
                    optionalSections.classList.add('show');
                    
                    // Show/hide sections based on verification type
                    billingSection.style.display = (verificationType === 'avs' || verificationType === 'full') ? 'block' : 'none';
                    customerSection.style.display = (verificationType === 'full') ? 'block' : 'none';
                }

                // Reinitialize verification form when type changes
                if (this.isInitialized) {
                    const operationMode = document.querySelector('input[name="operation_mode"]:checked').value;
                    if (operationMode === 'authentication') {
                        this.initializeVerificationForm();
                    }
                }
            }

            async handleVerificationTokenSuccess(tokenResponse) {
                try {
                    this.showLoading('Verifying card...');
                    
                    const verificationType = document.querySelector('input[name="verification_type"]:checked').value;
                    
                    const requestData = {
                        payment_token: tokenResponse.paymentReference,
                        verification_type: verificationType
                    };
                    
                    // Add billing address if needed
                    if (verificationType === 'avs' || verificationType === 'full') {
                        requestData.billing_address = {
                            street: document.getElementById('street').value,
                            city: document.getElementById('city').value,
                            state: document.getElementById('state').value,
                            postal_code: document.getElementById('postal_code').value,
                            country: 'US'
                        };
                    }
                    
                    // Add customer info if doing full verification
                    if (verificationType === 'full') {
                        requestData.customer = {
                            customer_id: document.getElementById('customer_id').value,
                            email: document.getElementById('email').value,
                            phone: document.getElementById('phone').value
                        };
                    }
                    
                    console.log('Verification request data:', requestData);
                    
                    const response = await fetch('/verify-card.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    console.log('Verification result:', result);
                    
                    if (result.success) {
                        this.showVerificationSuccess(result);
                    } else {
                        this.showError('Verification failed: ' + (result.message || 'Unknown error'));
                    }
                    
                } catch (error) {
                    this.showError('Network error: ' + error.message);
                } finally {
                    this.hideLoading();
                }
            }

            showVerificationSuccess(responseData) {
                const container = document.getElementById('result-container');
                const content = document.getElementById('result-content');
                
                content.innerHTML = `
                    <h3>✅ Card Verification Successful</h3>
                    <p>Your card has been verified successfully!</p>
                    <div style="margin-top: 15px; font-size: 0.9em;">
                        <strong>Verification Details:</strong><br>
                        Card Type: ${responseData.card_type || 'N/A'}<br>
                        Last Four: ${responseData.last_four || 'N/A'}<br>
                        Status: ${responseData.response_message || 'Verified'}<br>
                        Verification ID: ${responseData.transaction_id || 'N/A'}
                    </div>
                `;
                
                container.className = 'result-container result-success';
                container.style.display = 'block';
                
                // Scroll to results
                container.scrollIntoView({ behavior: 'smooth' });
            }

            showLoading(message = 'Processing...') {
                const loading = document.getElementById('loading');
                const loadingText = loading.querySelector('p');
                if (loadingText) loadingText.textContent = message;
                loading.style.display = 'flex';
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            }

            showError(message) {
                const container = document.getElementById('result-container');
                const content = document.getElementById('result-content');
                
                content.innerHTML = `
                    <h3>❌ Error</h3>
                    <p>${message}</p>
                `;
                
                container.className = 'result-container result-error';
                container.style.display = 'block';
                
                // Scroll to results
                container.scrollIntoView({ behavior: 'smooth' });
            }

            hideResult() {
                document.getElementById('result-container').style.display = 'none';
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new CardAuthenticator();
        });
    </script>
</body>
</html>
