<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Verification & Payment</title>
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Card Verification & Payment</h1>
            <p>Secure card verification and real transaction processing</p>
            <div style="margin-top: 15px;">
                <a href="dashboard.html" style="display: inline-block; padding: 10px 20px; background: #4285f4; color: white; text-decoration: none; border-radius: 8px; font-weight: 500; transition: background 0.3s ease;">
                    üìä View Transaction Dashboard
                </a>
            </div>
        </div>

        <div class="form-container">
            <div class="mode-selector">
                <div class="mode-toggle">
                    <input type="radio" id="auth-mode" name="operation_mode" value="authentication" checked>
                    <label for="auth-mode">
                        <strong>üîê Card Validation</strong>
                        <small>Verification without charges</small>
                    </label>
                    
                    <input type="radio" id="payment-mode" name="operation_mode" value="payment">
                    <label for="payment-mode">
                        <strong>üí≥ Real Payment Testing</strong>
                        <small>Process actual sandbox transactions</small>
                    </label>
                </div>
            </div>

            <div class="info-panel" id="auth-info-panel">
                <h4>üìã What is Card Verification?</h4>
                <ul>
                    <li><strong>Basic:</strong> Validates card number and expiration</li>
                    <li><strong>AVS:</strong> Verifies billing address matches card</li>
                    <li><strong>CVV:</strong> Confirms security code on card</li>
                    <li><strong>Full:</strong> Complete verification with all checks</li>
                </ul>
            </div>

            <div class="info-panel" id="payment-info-panel" style="display: none;">
                <h4>üí≥ Real Payment Processing</h4>
                <ul>
                    <li><strong>Secure:</strong> PCI-compliant hosted payment page</li>
                    <li><strong>Real Charges:</strong> Actual transaction processing</li>
                    <li><strong>Test Cards:</strong> Use Global Payments test cards</li>
                    <li><strong>Dashboard:</strong> View real transaction results</li>
                </ul>
            </div>

            <form id="verification-form">
                <div class="verification-type-selector">
                    <label>Choose Verification Type:</label>
                    <div class="verification-options">
                        <div class="verification-option">
                            <input type="radio" id="basic" name="verification_type" value="basic" checked>
                            <label for="basic">
                                <strong>Basic</strong>
                                <small>Card validation only</small>
                            </label>
                        </div>
                        <div class="verification-option">
                            <input type="radio" id="avs" name="verification_type" value="avs">
                            <label for="avs">
                                <strong>AVS Check</strong>
                                <small>Address verification</small>
                            </label>
                        </div>
                        <div class="verification-option">
                            <input type="radio" id="cvv" name="verification_type" value="cvv">
                            <label for="cvv">
                                <strong>CVV Check</strong>
                                <small>Security code validation</small>
                            </label>
                        </div>
                        <div class="verification-option">
                            <input type="radio" id="full" name="verification_type" value="full">
                            <label for="full">
                                <strong>Full Verification</strong>
                                <small>All checks combined</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="credit-card"></div>

                <div id="optional-sections" class="optional-sections">
                    <div class="form-section" id="billing-section">
                        <h3>üìç Billing Address (for AVS)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="street">Street Address</label>
                                <input type="text" id="street" name="street" placeholder="123 Main St">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="city">City</label>
                                <input type="text" id="city" name="city" placeholder="New York">
                            </div>
                            <div class="form-group">
                                <label for="state">State</label>
                                <input type="text" id="state" name="state" placeholder="NY" maxlength="2">
                            </div>
                            <div class="form-group">
                                <label for="postal_code">ZIP Code</label>
                                <input type="text" id="postal_code" name="postal_code" placeholder="12345">
                            </div>
                        </div>
                    </div>

                    <div class="form-section" id="customer-section">
                        <h3>üë§ Customer Information (Optional)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customer_id">Customer ID</label>
                                <input type="text" id="customer_id" name="customer_id" placeholder="CUST_12345">
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" placeholder="customer@example.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phone">Phone</label>
                                <input type="tel" id="phone" name="phone" placeholder="(555) 123-4567">
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Payment Form for HPP Integration -->
            <div id="payment-form" style="display: none;">
                <div class="form-section">
                    <h3>üí≥ Payment Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-amount">Amount (USD)</label>
                            <input type="number" id="payment-amount" name="payment-amount" placeholder="10.00" min="0.01" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="payment-currency">Currency</label>
                            <select id="payment-currency" name="payment-currency">
                                <option value="USD" selected>USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="CAD">CAD - Canadian Dollar</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>üë§ Customer Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-customer-first-name">First Name</label>
                            <input type="text" id="payment-customer-first-name" name="payment-customer-first-name" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label for="payment-customer-last-name">Last Name</label>
                            <input type="text" id="payment-customer-last-name" name="payment-customer-last-name" placeholder="Doe">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-customer-email">Email</label>
                            <input type="email" id="payment-customer-email" name="payment-customer-email" placeholder="john.doe@example.com">
                        </div>
                        <div class="form-group">
                            <label for="payment-customer-phone">Phone</label>
                            <input type="tel" id="payment-customer-phone" name="payment-customer-phone" placeholder="(555) 123-4567">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>üìç Billing Address (Optional)</h3>
                    
                    <!-- Country Selection - First Priority -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-billing-country">Country</label>
                            <select id="payment-billing-country" name="payment-billing-country" class="country-select">
                                <option value="">Select Country</option>
                                
                                <!-- Major English-speaking Countries -->
                                <option value="US" selected>üá∫üá∏ United States</option>
                                <option value="CA">üá®üá¶ Canada</option>
                                <option value="GB">üá¨üáß United Kingdom</option>
                                <option value="AU">üá¶üá∫ Australia</option>
                                <option value="IE">üáÆüá™ Ireland</option>
                                <option value="NZ">üá≥üáø New Zealand</option>
                                <option value="ZA">üáøüá¶ South Africa</option>
                                
                                <!-- Major European Countries -->
                                <option value="DE">üá©üá™ Germany</option>
                                <option value="FR">üá´üá∑ France</option>
                                <option value="IT">üáÆüáπ Italy</option>
                                <option value="ES">üá™üá∏ Spain</option>
                                <option value="NL">üá≥üá± Netherlands</option>
                                <option value="CH">üá®üá≠ Switzerland</option>
                                <option value="AT">üá¶üáπ Austria</option>
                                <option value="BE">üáßüá™ Belgium</option>
                                <option value="SE">üá∏üá™ Sweden</option>
                                <option value="NO">üá≥üá¥ Norway</option>
                                <option value="DK">üá©üá∞ Denmark</option>
                                <option value="FI">üá´üáÆ Finland</option>
                                <option value="PL">üáµüá± Poland</option>
                                <option value="PT">üáµüáπ Portugal</option>
                                <option value="GR">üá¨üá∑ Greece</option>
                                <option value="CZ">üá®üáø Czech Republic</option>
                                <option value="HU">üá≠üá∫ Hungary</option>
                                <option value="RO">üá∑üá¥ Romania</option>
                                <option value="BG">üáßüá¨ Bulgaria</option>
                                <option value="HR">üá≠üá∑ Croatia</option>
                                <option value="SI">üá∏üáÆ Slovenia</option>
                                <option value="SK">üá∏üá∞ Slovakia</option>
                                <option value="EE">üá™üá™ Estonia</option>
                                <option value="LV">üá±üáª Latvia</option>
                                <option value="LT">üá±üáπ Lithuania</option>
                                <option value="CY">üá®üáæ Cyprus</option>
                                <option value="MT">üá≤üáπ Malta</option>
                                <option value="LU">üá±üá∫ Luxembourg</option>
                                <option value="IS">üáÆüá∏ Iceland</option>
                                <option value="LI">üá±üáÆ Liechtenstein</option>
                                <option value="MC">üá≤üá® Monaco</option>
                                <option value="AD">üá¶üá© Andorra</option>
                                <option value="SM">üá∏üá≤ San Marino</option>
                                <option value="VA">üáªüá¶ Vatican City</option>
                                
                                <!-- Asia-Pacific -->
                                <option value="JP">üáØüáµ Japan</option>
                                <option value="CN">üá®üá≥ China</option>
                                <option value="KR">üá∞üá∑ South Korea</option>
                                <option value="IN">üáÆüá≥ India</option>
                                <option value="SG">üá∏üá¨ Singapore</option>
                                <option value="HK">üá≠üá∞ Hong Kong</option>
                                <option value="TW">üáπüáº Taiwan</option>
                                <option value="MY">üá≤üáæ Malaysia</option>
                                <option value="TH">üáπüá≠ Thailand</option>
                                <option value="ID">üáÆüá© Indonesia</option>
                                <option value="PH">üáµüá≠ Philippines</option>
                                <option value="VN">üáªüá≥ Vietnam</option>
                                <option value="PK">üáµüá∞ Pakistan</option>
                                <option value="BD">üáßüá© Bangladesh</option>
                                <option value="LK">üá±üá∞ Sri Lanka</option>
                                <option value="NP">üá≥üáµ Nepal</option>
                                <option value="MM">üá≤üá≤ Myanmar</option>
                                <option value="KH">üá∞üá≠ Cambodia</option>
                                <option value="LA">üá±üá¶ Laos</option>
                                <option value="BN">üáßüá≥ Brunei</option>
                                <option value="MN">üá≤üá≥ Mongolia</option>
                                
                                <!-- Americas -->
                                <option value="MX">üá≤üáΩ Mexico</option>
                                <option value="BR">üáßüá∑ Brazil</option>
                                <option value="AR">üá¶üá∑ Argentina</option>
                                <option value="CL">üá®üá± Chile</option>
                                <option value="CO">üá®üá¥ Colombia</option>
                                <option value="PE">üáµüá™ Peru</option>
                                <option value="VE">üáªüá™ Venezuela</option>
                                <option value="EC">üá™üá® Ecuador</option>
                                <option value="BO">üáßüá¥ Bolivia</option>
                                <option value="PY">üáµüáæ Paraguay</option>
                                <option value="UY">üá∫üáæ Uruguay</option>
                                <option value="GY">üá¨üáæ Guyana</option>
                                <option value="SR">üá∏üá∑ Suriname</option>
                                <option value="GT">üá¨üáπ Guatemala</option>
                                <option value="HN">üá≠üá≥ Honduras</option>
                                <option value="SV">üá∏üáª El Salvador</option>
                                <option value="NI">üá≥üáÆ Nicaragua</option>
                                <option value="CR">üá®üá∑ Costa Rica</option>
                                <option value="PA">üáµüá¶ Panama</option>
                                <option value="BZ">üáßüáø Belize</option>
                                <option value="JM">üáØüá≤ Jamaica</option>
                                <option value="CU">üá®üá∫ Cuba</option>
                                <option value="DO">üá©üá¥ Dominican Republic</option>
                                <option value="HT">üá≠üáπ Haiti</option>
                                <option value="TT">üáπüáπ Trinidad and Tobago</option>
                                <option value="BB">üáßüáß Barbados</option>
                                <option value="BS">üáßüá∏ Bahamas</option>
                                
                                <!-- Middle East -->
                                <option value="AE">üá¶üá™ United Arab Emirates</option>
                                <option value="SA">üá∏üá¶ Saudi Arabia</option>
                                <option value="IL">üáÆüá± Israel</option>
                                <option value="TR">üáπüá∑ Turkey</option>
                                <option value="IR">üáÆüá∑ Iran</option>
                                <option value="IQ">üáÆüá∂ Iraq</option>
                                <option value="JO">üáØüá¥ Jordan</option>
                                <option value="LB">üá±üáß Lebanon</option>
                                <option value="SY">üá∏üáæ Syria</option>
                                <option value="YE">üáæüá™ Yemen</option>
                                <option value="OM">üá¥üá≤ Oman</option>
                                <option value="QA">üá∂üá¶ Qatar</option>
                                <option value="BH">üáßüá≠ Bahrain</option>
                                <option value="KW">üá∞üáº Kuwait</option>
                                <option value="PS">üáµüá∏ Palestine</option>
                                <option value="AF">üá¶üá´ Afghanistan</option>
                                
                                <!-- Africa -->
                                <option value="NG">üá≥üá¨ Nigeria</option>
                                <option value="EG">üá™üá¨ Egypt</option>
                                <option value="ET">üá™üáπ Ethiopia</option>
                                <option value="KE">üá∞üá™ Kenya</option>
                                <option value="UG">üá∫üá¨ Uganda</option>
                                <option value="TZ">üáπüáø Tanzania</option>
                                <option value="GH">üá¨üá≠ Ghana</option>
                                <option value="MZ">üá≤üáø Mozambique</option>
                                <option value="MG">üá≤üá¨ Madagascar</option>
                                <option value="AO">üá¶üá¥ Angola</option>
                                <option value="CM">üá®üá≤ Cameroon</option>
                                <option value="CI">üá®üáÆ Ivory Coast</option>
                                <option value="NE">üá≥üá™ Niger</option>
                                <option value="BF">üáßüá´ Burkina Faso</option>
                                <option value="ML">üá≤üá± Mali</option>
                                <option value="MW">üá≤üáº Malawi</option>
                                <option value="ZM">üáøüá≤ Zambia</option>
                                <option value="SN">üá∏üá≥ Senegal</option>
                                <option value="SO">üá∏üá¥ Somalia</option>
                                <option value="TD">üáπüá© Chad</option>
                                <option value="ZW">üáøüáº Zimbabwe</option>
                                <option value="BW">üáßüáº Botswana</option>
                                <option value="NA">üá≥üá¶ Namibia</option>
                                <option value="LS">üá±üá∏ Lesotho</option>
                                <option value="SZ">üá∏üáø Eswatini</option>
                                <option value="GA">üá¨üá¶ Gabon</option>
                                <option value="GQ">üá¨üá∂ Equatorial Guinea</option>
                                <option value="CG">üá®üá¨ Republic of the Congo</option>
                                <option value="CD">üá®üá© Democratic Republic of the Congo</option>
                                <option value="CF">üá®üá´ Central African Republic</option>
                                <option value="ST">üá∏üáπ S√£o Tom√© and Pr√≠ncipe</option>
                                <option value="DJ">üá©üáØ Djibouti</option>
                                <option value="ER">üá™üá∑ Eritrea</option>
                                <option value="GM">üá¨üá≤ Gambia</option>
                                <option value="GN">üá¨üá≥ Guinea</option>
                                <option value="GW">üá¨üáº Guinea-Bissau</option>
                                <option value="LR">üá±üá∑ Liberia</option>
                                <option value="SL">üá∏üá± Sierra Leone</option>
                                <option value="TG">üáπüá¨ Togo</option>
                                <option value="BJ">üáßüáØ Benin</option>
                                <option value="RW">üá∑üáº Rwanda</option>
                                <option value="BI">üáßüáÆ Burundi</option>
                                <option value="KM">üá∞üá≤ Comoros</option>
                                <option value="MU">üá≤üá∫ Mauritius</option>
                                <option value="SC">üá∏üá® Seychelles</option>
                                <option value="CV">üá®üáª Cape Verde</option>
                                <option value="MR">üá≤üá∑ Mauritania</option>
                                <option value="MA">üá≤üá¶ Morocco</option>
                                <option value="DZ">üá©üáø Algeria</option>
                                <option value="TN">üáπüá≥ Tunisia</option>
                                <option value="LY">üá±üáæ Libya</option>
                                <option value="SD">üá∏üá© Sudan</option>
                                <option value="SS">üá∏üá∏ South Sudan</option>
                                
                                <!-- Eastern Europe & Russia -->
                                <option value="RU">üá∑üá∫ Russia</option>
                                <option value="UA">üá∫üá¶ Ukraine</option>
                                <option value="BY">üáßüáæ Belarus</option>
                                <option value="MD">üá≤üá© Moldova</option>
                                <option value="GE">üá¨üá™ Georgia</option>
                                <option value="AM">üá¶üá≤ Armenia</option>
                                <option value="AZ">üá¶üáø Azerbaijan</option>
                                <option value="KZ">üá∞üáø Kazakhstan</option>
                                <option value="KG">üá∞üá¨ Kyrgyzstan</option>
                                <option value="TJ">üáπüáØ Tajikistan</option>
                                <option value="TM">üáπüá≤ Turkmenistan</option>
                                <option value="UZ">üá∫üáø Uzbekistan</option>
                                <option value="RS">üá∑üá∏ Serbia</option>
                                <option value="ME">üá≤üá™ Montenegro</option>
                                <option value="BA">üáßüá¶ Bosnia and Herzegovina</option>
                                <option value="MK">üá≤üá∞ North Macedonia</option>
                                <option value="AL">üá¶üá± Albania</option>
                                <option value="XK">üáΩüá∞ Kosovo</option>
                                
                                <!-- Oceania -->
                                <option value="FJ">üá´üáØ Fiji</option>
                                <option value="PG">üáµüá¨ Papua New Guinea</option>
                                <option value="SB">üá∏üáß Solomon Islands</option>
                                <option value="VU">üáªüá∫ Vanuatu</option>
                                <option value="NC">üá≥üá® New Caledonia</option>
                                <option value="PF">üáµüá´ French Polynesia</option>
                                <option value="WS">üáºüá∏ Samoa</option>
                                <option value="TO">üáπüá¥ Tonga</option>
                                <option value="KI">üá∞üáÆ Kiribati</option>
                                <option value="TV">üáπüáª Tuvalu</option>
                                <option value="NR">üá≥üá∑ Nauru</option>
                                <option value="PW">üáµüáº Palau</option>
                                <option value="MH">üá≤üá≠ Marshall Islands</option>
                                <option value="FM">üá´üá≤ Micronesia</option>
                            </select>
                        </div>
                    </div>

                    <!-- Street Address -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-billing-street" id="street-label">Street Address</label>
                            <input type="text" id="payment-billing-street" name="payment-billing-street" 
                                   placeholder="123 Main St" class="address-field">
                        </div>
                    </div>

                    <!-- City, State/Province, Postal Code Row -->
                    <div class="form-row address-row">
                        <div class="form-group">
                            <label for="payment-billing-city" id="city-label">City</label>
                            <input type="text" id="payment-billing-city" name="payment-billing-city" 
                                   placeholder="New York" class="address-field">
                        </div>
                        <div class="form-group">
                            <label for="payment-billing-state" id="state-label">State</label>
                            <input type="text" id="payment-billing-state" name="payment-billing-state" 
                                   placeholder="NY" maxlength="10" class="address-field">
                        </div>
                        <div class="form-group">
                            <label for="payment-billing-postal" id="postal-label">ZIP Code</label>
                            <input type="text" id="payment-billing-postal" name="payment-billing-postal" 
                                   placeholder="12345" class="address-field">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <button type="button" id="start-payment-btn" class="payment-button">
                        üöÄ Start Secure Payment
                    </button>
                    <p class="payment-note">
                        Global Payments secure payment form will open in this page
                    </p>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Verifying card...</p>
            </div>

            <div class="result-container" id="result-container">
                <div id="result-content"></div>
            </div>
        </div>
    </div>

    <script src="https://js.globalpay.com/v1/globalpayments.js"></script>
    <script>
        class CardAuthenticator {
            constructor() {
                this.cardForm = null;
                this.isInitialized = false;
                this.init();
            }

            async init() {
                try {
                    await this.ensureGlobalPaymentsReady();
                    await this.loadConfiguration();
                    this.setupEventListeners();
                    this.updateFormVisibility();
                    console.log('‚úÖ Card authenticator initialized');
                } catch (error) {
                    this.showError('Failed to initialize payment form: ' + error.message);
                }
            }

            ensureGlobalPaymentsReady() {
                return new Promise((resolve, reject) => {
                    if (typeof GlobalPayments !== 'undefined') {
                        resolve();
                    } else {
                        let attempts = 0;
                        const checkInterval = setInterval(() => {
                            attempts++;
                            if (typeof GlobalPayments !== 'undefined') {
                                clearInterval(checkInterval);
                                resolve();
                            } else if (attempts >= 20) {
                                clearInterval(checkInterval);
                                reject(new Error('GlobalPayments SDK failed to load'));
                            }
                        }, 250);
                    }
                });
            }

            async loadConfiguration() {
                const response = await fetch('/config.php');
                if (!response.ok) {
                    throw new Error(`Configuration error: ${response.status}`);
                }
                
                const config = await response.json();
                if (!config.success) {
                    throw new Error('Invalid configuration response');
                }

                GlobalPayments.configure({
                    publicApiKey: config.data.publicApiKey
                });

                this.initializeCardForm();
            }

            initializeCardForm() {
                this.cardForm = GlobalPayments.creditCard.form('#verification-form', { 
                    style: "gp-default" 
                });

                this.cardForm.on('token-success', (resp) => {
                    this.handleTokenSuccess(resp);
                });

                this.cardForm.on('token-error', (error) => {
                    this.showError('Card tokenization failed: ' + error.message);
                    this.hideLoading();
                });

                this.isInitialized = true;
            }

            setupEventListeners() {
                // Operation mode change
                document.querySelectorAll('input[name="operation_mode"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.updateOperationMode();
                    });
                });

                // Verification type change
                document.querySelectorAll('input[name="verification_type"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.updateFormVisibility();
                    });
                });

                // Payment button click
                const paymentBtn = document.getElementById('start-payment-btn');
                if (paymentBtn) {
                    paymentBtn.addEventListener('click', () => {
                        this.initiatePayment();
                    });
                }

                // Country selection change
                const countrySelect = document.getElementById('payment-billing-country');
                if (countrySelect) {
                    countrySelect.addEventListener('change', (e) => {
                        this.updateAddressFields(e.target.value);
                    });
                    // Initialize with default country
                    this.updateAddressFields(countrySelect.value);
                }

                // Form submission is handled by the GlobalPayments SDK automatically
                // The token-success event will be triggered when the form is submitted
            }

            updateOperationMode() {
                const operationMode = document.querySelector('input[name="operation_mode"]:checked').value;
                const authInfoPanel = document.getElementById('auth-info-panel');
                const paymentInfoPanel = document.getElementById('payment-info-panel');
                const verificationForm = document.getElementById('verification-form');
                const paymentForm = document.getElementById('payment-form');
                const resultContainer = document.getElementById('result-container');

                if (operationMode === 'authentication') {
                    // Show authentication UI
                    authInfoPanel.style.display = 'block';
                    paymentInfoPanel.style.display = 'none';
                    verificationForm.style.display = 'block';
                    paymentForm.style.display = 'none';
                } else {
                    // Show payment UI
                    authInfoPanel.style.display = 'none';
                    paymentInfoPanel.style.display = 'block';
                    verificationForm.style.display = 'none';
                    paymentForm.style.display = 'block';
                    
                    // Order ID will be automatically generated server-side
                }

                // Hide results when switching modes
                resultContainer.style.display = 'none';
            }

            updateFormVisibility() {
                const verificationType = document.querySelector('input[name="verification_type"]:checked').value;
                const optionalSections = document.getElementById('optional-sections');
                const billingSection = document.getElementById('billing-section');
                const customerSection = document.getElementById('customer-section');

                if (verificationType === 'basic') {
                    optionalSections.classList.remove('show');
                } else {
                    optionalSections.classList.add('show');
                    
                    // Show/hide sections based on verification type
                    billingSection.style.display = (verificationType === 'avs' || verificationType === 'full') ? 'block' : 'none';
                    customerSection.style.display = (verificationType === 'full') ? 'block' : 'none';
                }
            }

            async initiatePayment() {
                try {
                    this.showLoading('Creating secure payment session...');

                    // Collect payment data (Order ID generated automatically server-side)
                    const paymentData = {
                        amount: document.getElementById('payment-amount').value,
                        currency: document.getElementById('payment-currency').value
                    };

                    // Validate required fields
                    if (!paymentData.amount) {
                        throw new Error('Amount is required');
                    }

                    // Add customer data if provided
                    const firstName = document.getElementById('payment-customer-first-name').value;
                    const lastName = document.getElementById('payment-customer-last-name').value;
                    const email = document.getElementById('payment-customer-email').value;
                    const phone = document.getElementById('payment-customer-phone').value;

                    if (firstName || lastName || email || phone) {
                        paymentData.customer = {
                            first_name: firstName,
                            last_name: lastName,
                            email: email,
                            phone: phone
                        };
                    }

                    // Add billing address if provided
                    const street = document.getElementById('payment-billing-street').value;
                    const city = document.getElementById('payment-billing-city').value;
                    const state = document.getElementById('payment-billing-state').value;
                    const postal = document.getElementById('payment-billing-postal').value;
                    const country = document.getElementById('payment-billing-country').value;

                    if (street || city || state || postal || country) {
                        paymentData.billing_address = {
                            street: street,
                            city: city,
                            state: state,
                            postal_code: postal,
                            country: country
                        };
                    }

                    // Create HPP session
                    const response = await fetch('/hpp-create-session.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(paymentData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Show HPP iframe instead of redirecting
                        this.showHppIframe(result.data.iframe_url, paymentData);
                    } else {
                        throw new Error(result.message || 'Failed to create payment session');
                    }

                } catch (error) {
                    this.showError('Payment initiation failed: ' + error.message);
                } finally {
                    this.hideLoading();
                }
            }

            async handleTokenSuccess(tokenResponse) {
                try {
                    this.showLoading(); // Show loading when we start processing
                    
                    const verificationType = document.querySelector('input[name="verification_type"]:checked').value;
                    
                    const requestData = {
                        payment_token: tokenResponse.paymentReference,
                        verification_type: verificationType
                    };

                    // Add billing address if needed
                    if (verificationType === 'avs' || verificationType === 'full') {
                        requestData.billing_address = {
                            street: document.getElementById('street').value,
                            city: document.getElementById('city').value,
                            state: document.getElementById('state').value,
                            postal_code: document.getElementById('postal_code').value
                        };
                    }

                    // Add customer info if needed
                    if (verificationType === 'full') {
                        requestData.customer = {
                            id: document.getElementById('customer_id').value,
                            email: document.getElementById('email').value,
                            phone: document.getElementById('phone').value
                        };
                    }

                    const response = await fetch('/verify-card.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.showSuccess(result);
                    } else {
                        this.showError(result.message, result);
                    }

                } catch (error) {
                    this.showError('Network error: ' + error.message);
                } finally {
                    this.hideLoading();
                }
            }

            showLoading(message = 'Verifying card...') {
                const loading = document.getElementById('loading');
                const loadingText = loading.querySelector('p');
                loadingText.textContent = message;
                loading.style.display = 'block';
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            }

            showSuccess(result) {
                const container = document.getElementById('result-container');
                const content = document.getElementById('result-content');
                
                let detailsHtml = '';
                if (result.verification_result) {
                    const vr = result.verification_result;
                    detailsHtml = `
                        <div style="margin-top: 15px; font-size: 0.9em;">
                            <strong>Verification Details:</strong><br>
                            Transaction ID: ${vr.transaction_id}<br>
                            Response: ${vr.response_code} - ${vr.response_message}
                            ${vr.avs_response_code ? `<br>AVS: ${vr.avs_response_code} - ${vr.avs_response_message}` : ''}
                            ${vr.cvn_response_code ? `<br>CVV: ${vr.cvn_response_code} - ${vr.cvn_response_message}` : ''}
                            ${vr.card_type ? `<br>Card Type: ${vr.card_type}` : ''}
                        </div>
                    `;
                }

                content.innerHTML = `
                    <h3>‚úÖ ${result.message}</h3>
                    <p>Card verification completed successfully!</p>
                    ${detailsHtml}
                `;
                
                container.className = 'result-container result-success';
                container.style.display = 'block';
            }

            showError(message, result = null) {
                const container = document.getElementById('result-container');
                const content = document.getElementById('result-content');
                
                let detailsHtml = '';
                if (result && result.verification_result) {
                    const vr = result.verification_result;
                    detailsHtml = `
                        <div style="margin-top: 15px; font-size: 0.9em;">
                            <strong>Response Details:</strong><br>
                            ${vr.response_code ? `Code: ${vr.response_code}<br>` : ''}
                            ${vr.response_message ? `Message: ${vr.response_message}<br>` : ''}
                            ${vr.transaction_id ? `Transaction ID: ${vr.transaction_id}` : ''}
                        </div>
                    `;
                }

                content.innerHTML = `
                    <div class="result error">
                        <div class="result-header">
                            <span class="result-icon">‚ùå</span>
                            <span class="result-title">Verification Failed</span>
                        </div>
                        <div class="result-message">${message}</div>
                        ${detailsHtml}
                    </div>
                `;
                
                container.style.display = 'block';
            }

            showHppIframe(iframeUrl, paymentData) {
                // Hide payment form and show iframe container
                const paymentForm = document.getElementById('payment-form');
                const container = document.getElementById('result-container');
                const content = document.getElementById('result-content');
                
                paymentForm.style.display = 'none';
                
                content.innerHTML = `
                    <div class="hpp-container">
                        <div class="hpp-header">
                            <h3>üîí Secure Payment</h3>
                            <p>Complete your payment of $${paymentData.amount} ${paymentData.currency}</p>
                            <button type="button" id="close-hpp" class="close-button">‚úï Close</button>
                        </div>
                        <div class="hpp-iframe-wrapper">
                            <iframe 
                                id="hpp-iframe" 
                                src="${iframeUrl}" 
                                width="100%" 
                                height="600"
                                frameborder="0"
                                scrolling="auto"
                                sandbox="allow-forms allow-scripts allow-same-origin allow-top-navigation"
                                title="Global Payments Hosted Payment Page">
                            </iframe>
                        </div>
                        <div class="hpp-footer">
                            <p>üîí Your payment is processed securely by Global Payments</p>
                        </div>
                    </div>
                `;
                
                container.style.display = 'block';
                
                // Add close button functionality
                document.getElementById('close-hpp').addEventListener('click', () => {
                    this.closeHppIframe();
                });
                
                // Listen for messages from the iframe (payment completion)
                this.setupIframeListeners();
            }

            closeHppIframe() {
                const paymentForm = document.getElementById('payment-form');
                const container = document.getElementById('result-container');
                
                container.style.display = 'none';
                paymentForm.style.display = 'block';
            }

            setupIframeListeners() {
                // Listen for postMessage events from the HPP iframe
                window.addEventListener('message', (event) => {
                    // Verify origin for security (adjust based on your Global Payments environment)
                    const allowedOrigins = [
                        'https://apis.sandbox.globalpay.com',
                        'https://hpp.sandbox.globalpay.com',
                        'https://apis.globalpay.com',
                        'https://hpp.globalpay.com'
                    ];
                    
                    if (!allowedOrigins.includes(event.origin)) {
                        return;
                    }
                    
                    // Handle payment completion messages
                    if (event.data && event.data.type === 'payment_complete') {
                        this.handlePaymentComplete(event.data);
                    }
                }, { once: true });
            }

            handlePaymentComplete(paymentResult) {
                // Close the iframe
                this.closeHppIframe();
                
                // Show payment result
                if (paymentResult.status === 'success' || paymentResult.status === 'approved') {
                    this.showPaymentSuccess(paymentResult);
                } else {
                    this.showPaymentError(paymentResult);
                }
            }

            showPaymentSuccess(result) {
                const container = document.getElementById('result-container');
                const content = document.getElementById('result-content');
                
                content.innerHTML = `
                    <div class="result success">
                        <div class="result-header">
                            <span class="result-icon">‚úÖ</span>
                            <span class="result-title">Payment Successful</span>
                        </div>
                        <div class="result-message">Your payment has been processed successfully!</div>
                        <div style="margin-top: 15px; font-size: 0.9em;">
                            <strong>Payment Details:</strong><br>
                            ${result.transaction_id ? `Transaction ID: ${result.transaction_id}<br>` : ''}
                            ${result.amount ? `Amount: $${result.amount} ${result.currency || 'USD'}<br>` : ''}
                            ${result.reference ? `Reference: ${result.reference}<br>` : ''}
                            ${result.payment_method ? `Payment Method: ${result.payment_method}` : ''}
                        </div>
                    </div>
                `;
                
                container.style.display = 'block';
            }

            showPaymentError(result) {
                const container = document.getElementById('result-container');
                const content = document.getElementById('result-content');
                
                content.innerHTML = `
                    <div class="result error">
                        <div class="result-header">
                            <span class="result-icon">‚ùå</span>
                            <span class="result-title">Payment Failed</span>
                        </div>
                        <div class="result-message">${result.message || 'Payment could not be processed'}</div>
                        <div style="margin-top: 15px; font-size: 0.9em;">
                            <strong>Error Details:</strong><br>
                            ${result.error_code ? `Code: ${result.error_code}<br>` : ''}
                            ${result.transaction_id ? `Transaction ID: ${result.transaction_id}` : ''}
                        </div>
                    </div>
                `;
                
                container.style.display = 'block';
            }

            hideResult() {
                document.getElementById('result-container').style.display = 'none';
            }

            /**
             * Update address field labels and placeholders based on selected country
             * @param {string} countryCode - The selected country code (e.g., 'US', 'GB', 'CA')
             */
            updateAddressFields(countryCode) {
                const streetLabel = document.getElementById('street-label');
                const cityLabel = document.getElementById('city-label');
                const stateLabel = document.getElementById('state-label');
                const postalLabel = document.getElementById('postal-label');
                
                const streetField = document.getElementById('payment-billing-street');
                const cityField = document.getElementById('payment-billing-city');
                const stateField = document.getElementById('payment-billing-state');
                const postalField = document.getElementById('payment-billing-postal');

                // Country-specific address format configurations
                const addressFormats = {
                    'US': {
                        street: { label: 'Street Address', placeholder: '123 Main St' },
                        city: { label: 'City', placeholder: 'New York' },
                        state: { label: 'State', placeholder: 'NY' },
                        postal: { label: 'ZIP Code', placeholder: '12345' }
                    },
                    'CA': {
                        street: { label: 'Street Address', placeholder: '123 Main St' },
                        city: { label: 'City', placeholder: 'Toronto' },
                        state: { label: 'Province', placeholder: 'ON' },
                        postal: { label: 'Postal Code', placeholder: 'K1A 0A6' }
                    },
                    'GB': {
                        street: { label: 'Address Line 1', placeholder: '123 High Street' },
                        city: { label: 'Town/City', placeholder: 'London' },
                        state: { label: 'County', placeholder: 'Greater London' },
                        postal: { label: 'Postcode', placeholder: 'SW1A 1AA' }
                    },
                    'IE': {
                        street: { label: 'Address Line 1', placeholder: '123 Grafton Street' },
                        city: { label: 'Town/City', placeholder: 'Dublin' },
                        state: { label: 'County', placeholder: 'Dublin' },
                        postal: { label: 'Eircode', placeholder: 'D02 XY45' }
                    },
                    'AU': {
                        street: { label: 'Street Address', placeholder: '123 Collins Street' },
                        city: { label: 'Suburb', placeholder: 'Melbourne' },
                        state: { label: 'State', placeholder: 'VIC' },
                        postal: { label: 'Postcode', placeholder: '3000' }
                    },
                    'NZ': {
                        street: { label: 'Street Address', placeholder: '123 Queen Street' },
                        city: { label: 'Suburb', placeholder: 'Auckland' },
                        state: { label: 'Region', placeholder: 'Auckland' },
                        postal: { label: 'Postcode', placeholder: '1010' }
                    },
                    'ZA': {
                        street: { label: 'Street Address', placeholder: '123 Long Street' },
                        city: { label: 'City', placeholder: 'Cape Town' },
                        state: { label: 'Province', placeholder: 'Western Cape' },
                        postal: { label: 'Postal Code', placeholder: '8001' }
                    },
                    'DE': {
                        street: { label: 'Stra√üe und Hausnummer', placeholder: 'Musterstra√üe 123' },
                        city: { label: 'Stadt', placeholder: 'Berlin' },
                        state: { label: 'Bundesland', placeholder: 'Berlin' },
                        postal: { label: 'Postleitzahl', placeholder: '10115' }
                    },
                    'FR': {
                        street: { label: 'Adresse', placeholder: '123 Rue de la Paix' },
                        city: { label: 'Ville', placeholder: 'Paris' },
                        state: { label: 'R√©gion', placeholder: '√éle-de-France' },
                        postal: { label: 'Code postal', placeholder: '75001' }
                    },
                    'IT': {
                        street: { label: 'Indirizzo', placeholder: 'Via Roma 123' },
                        city: { label: 'Citt√†', placeholder: 'Roma' },
                        state: { label: 'Provincia', placeholder: 'RM' },
                        postal: { label: 'CAP', placeholder: '00100' }
                    },
                    'ES': {
                        street: { label: 'Direcci√≥n', placeholder: 'Calle Mayor 123' },
                        city: { label: 'Ciudad', placeholder: 'Madrid' },
                        state: { label: 'Provincia', placeholder: 'Madrid' },
                        postal: { label: 'C√≥digo postal', placeholder: '28001' }
                    },
                    'NL': {
                        street: { label: 'Adres', placeholder: 'Hoofdstraat 123' },
                        city: { label: 'Plaats', placeholder: 'Amsterdam' },
                        state: { label: 'Provincie', placeholder: 'Noord-Holland' },
                        postal: { label: 'Postcode', placeholder: '1012 AB' }
                    },
                    'CH': {
                        street: { label: 'Adresse', placeholder: 'Bahnhofstrasse 123' },
                        city: { label: 'Stadt', placeholder: 'Z√ºrich' },
                        state: { label: 'Kanton', placeholder: 'ZH' },
                        postal: { label: 'PLZ', placeholder: '8001' }
                    },
                    'AT': {
                        street: { label: 'Adresse', placeholder: 'Ringstra√üe 123' },
                        city: { label: 'Stadt', placeholder: 'Wien' },
                        state: { label: 'Bundesland', placeholder: 'Wien' },
                        postal: { label: 'PLZ', placeholder: '1010' }
                    },
                    'BE': {
                        street: { label: 'Adresse/Adres', placeholder: 'Rue de la Loi 123' },
                        city: { label: 'Ville/Stad', placeholder: 'Brussels' },
                        state: { label: 'Province/Provincie', placeholder: 'Brussels' },
                        postal: { label: 'Code postal', placeholder: '1000' }
                    },
                    'SE': {
                        street: { label: 'Gatuadress', placeholder: 'Drottninggatan 123' },
                        city: { label: 'Stad', placeholder: 'Stockholm' },
                        state: { label: 'L√§n', placeholder: 'Stockholm' },
                        postal: { label: 'Postnummer', placeholder: '11151' }
                    },
                    'NO': {
                        street: { label: 'Gateadresse', placeholder: 'Karl Johans gate 123' },
                        city: { label: 'Poststed', placeholder: 'Oslo' },
                        state: { label: 'Fylke', placeholder: 'Oslo' },
                        postal: { label: 'Postnummer', placeholder: '0154' }
                    },
                    'DK': {
                        street: { label: 'Adresse', placeholder: 'Str√∏get 123' },
                        city: { label: 'By', placeholder: 'K√∏benhavn' },
                        state: { label: 'Region', placeholder: 'Hovedstaden' },
                        postal: { label: 'Postnummer', placeholder: '1000' }
                    },
                    'FI': {
                        street: { label: 'Katuosoite', placeholder: 'Mannerheimintie 123' },
                        city: { label: 'Kaupunki', placeholder: 'Helsinki' },
                        state: { label: 'Maakunta', placeholder: 'Uusimaa' },
                        postal: { label: 'Postinumero', placeholder: '00100' }
                    },
                    'JP': {
                        street: { label: '‰ΩèÊâÄ', placeholder: 'Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫1-2-3' },
                        city: { label: 'Â∏ÇÂå∫Áî∫Êùë', placeholder: 'Ê∏ãË∞∑Âå∫' },
                        state: { label: 'ÈÉΩÈÅìÂ∫úÁúå', placeholder: 'Êù±‰∫¨ÈÉΩ' },
                        postal: { label: 'ÈÉµ‰æøÁï™Âè∑', placeholder: '150-0001' }
                    },
                    'CN': {
                        street: { label: 'Ë°óÈÅìÂú∞ÂùÄ', placeholder: 'Âçó‰∫¨Ë∑Ø123Âè∑' },
                        city: { label: 'ÂüéÂ∏Ç', placeholder: '‰∏äÊµ∑' },
                        state: { label: 'ÁúÅ/Áõ¥ËæñÂ∏Ç', placeholder: '‰∏äÊµ∑Â∏Ç' },
                        postal: { label: 'ÈÇÆÊîøÁºñÁ†Å', placeholder: '200001' }
                    },
                    'KR': {
                        street: { label: 'ÎèÑÎ°úÎ™ÖÏ£ºÏÜå', placeholder: 'Í∞ïÎÇ®ÎåÄÎ°ú 123' },
                        city: { label: 'Ïãú/Íµ∞/Íµ¨', placeholder: 'ÏÑúÏö∏Ïãú Í∞ïÎÇ®Íµ¨' },
                        state: { label: 'Ïãú/ÎèÑ', placeholder: 'ÏÑúÏö∏ÌäπÎ≥ÑÏãú' },
                        postal: { label: 'Ïö∞Ìé∏Î≤àÌò∏', placeholder: '06292' }
                    },
                    'IN': {
                        street: { label: 'Address Line 1', placeholder: '123 MG Road' },
                        city: { label: 'City', placeholder: 'Mumbai' },
                        state: { label: 'State', placeholder: 'Maharashtra' },
                        postal: { label: 'PIN Code', placeholder: '400001' }
                    },
                    'SG': {
                        street: { label: 'Block/Street', placeholder: '123 Orchard Road' },
                        city: { label: 'City', placeholder: 'Singapore' },
                        state: { label: 'District', placeholder: 'Central' },
                        postal: { label: 'Postal Code', placeholder: '238874' }
                    },
                    'HK': {
                        street: { label: 'Address Line 1', placeholder: '123 Nathan Road' },
                        city: { label: 'District', placeholder: 'Tsim Sha Tsui' },
                        state: { label: 'Region', placeholder: 'Kowloon' },
                        postal: { label: 'Postal Code', placeholder: '' }
                    },
                    'TW': {
                        street: { label: 'Âú∞ÂùÄ', placeholder: '‰∏≠Â±±Ë∑Ø123Ëôü' },
                        city: { label: 'Â∏Ç/Á∏£', placeholder: 'Âè∞ÂåóÂ∏Ç' },
                        state: { label: 'Á∏£Â∏Ç', placeholder: 'Âè∞ÂåóÂ∏Ç' },
                        postal: { label: 'ÈÉµÈÅûÂçÄËôü', placeholder: '100' }
                    },
                    'BR': {
                        street: { label: 'Endere√ßo', placeholder: 'Rua das Flores, 123' },
                        city: { label: 'Cidade', placeholder: 'S√£o Paulo' },
                        state: { label: 'Estado', placeholder: 'SP' },
                        postal: { label: 'CEP', placeholder: '01234-567' }
                    },
                    'MX': {
                        street: { label: 'Direcci√≥n', placeholder: 'Calle Principal 123' },
                        city: { label: 'Ciudad', placeholder: 'Ciudad de M√©xico' },
                        state: { label: 'Estado', placeholder: 'CDMX' },
                        postal: { label: 'C√≥digo postal', placeholder: '06000' }
                    },
                    'AR': {
                        street: { label: 'Direcci√≥n', placeholder: 'Av. Corrientes 123' },
                        city: { label: 'Ciudad', placeholder: 'Buenos Aires' },
                        state: { label: 'Provincia', placeholder: 'CABA' },
                        postal: { label: 'C√≥digo postal', placeholder: 'C1043' }
                    },
                    'CL': {
                        street: { label: 'Direcci√≥n', placeholder: 'Av. Providencia 123' },
                        city: { label: 'Ciudad', placeholder: 'Santiago' },
                        state: { label: 'Regi√≥n', placeholder: 'Metropolitana' },
                        postal: { label: 'C√≥digo postal', placeholder: '7500000' }
                    },
                    'CO': {
                        street: { label: 'Direcci√≥n', placeholder: 'Carrera 7 # 123-45' },
                        city: { label: 'Ciudad', placeholder: 'Bogot√°' },
                        state: { label: 'Departamento', placeholder: 'Cundinamarca' },
                        postal: { label: 'C√≥digo postal', placeholder: '110111' }
                    },
                    'PE': {
                        street: { label: 'Direcci√≥n', placeholder: 'Av. Arequipa 123' },
                        city: { label: 'Ciudad', placeholder: 'Lima' },
                        state: { label: 'Regi√≥n', placeholder: 'Lima' },
                        postal: { label: 'C√≥digo postal', placeholder: '15001' }
                    },
                    'RU': {
                        street: { label: '–ê–¥—Ä–µ—Å', placeholder: '—É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, 123' },
                        city: { label: '–ì–æ—Ä–æ–¥', placeholder: '–ú–æ—Å–∫–≤–∞' },
                        state: { label: '–†–µ–≥–∏–æ–Ω', placeholder: '–ú–æ—Å–∫–≤–∞' },
                        postal: { label: '–ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å', placeholder: '125009' }
                    },
                    'TR': {
                        street: { label: 'Adres', placeholder: 'ƒ∞stiklal Caddesi 123' },
                        city: { label: '≈ûehir', placeholder: 'ƒ∞stanbul' },
                        state: { label: 'ƒ∞l', placeholder: 'ƒ∞stanbul' },
                        postal: { label: 'Posta Kodu', placeholder: '34000' }
                    },
                    'PL': {
                        street: { label: 'Adres', placeholder: 'ul. Marsza≈Çkowska 123' },
                        city: { label: 'Miasto', placeholder: 'Warszawa' },
                        state: { label: 'Wojew√≥dztwo', placeholder: 'Mazowieckie' },
                        postal: { label: 'Kod pocztowy', placeholder: '00-001' }
                    },
                    'CZ': {
                        street: { label: 'Adresa', placeholder: 'V√°clavsk√© n√°mƒõst√≠ 123' },
                        city: { label: 'Mƒõsto', placeholder: 'Praha' },
                        state: { label: 'Kraj', placeholder: 'Praha' },
                        postal: { label: 'PSƒå', placeholder: '110 00' }
                    },
                    'HU': {
                        street: { label: 'C√≠m', placeholder: 'V√°ci utca 123' },
                        city: { label: 'V√°ros', placeholder: 'Budapest' },
                        state: { label: 'Megye', placeholder: 'Budapest' },
                        postal: { label: 'Ir√°ny√≠t√≥sz√°m', placeholder: '1052' }
                    },
                    'PT': {
                        street: { label: 'Morada', placeholder: 'Rua Augusta 123' },
                        city: { label: 'Cidade', placeholder: 'Lisboa' },
                        state: { label: 'Distrito', placeholder: 'Lisboa' },
                        postal: { label: 'C√≥digo postal', placeholder: '1100-048' }
                    },
                    'GR': {
                        street: { label: 'ŒîŒπŒµœçŒ∏œÖŒΩœÉŒ∑', placeholder: 'ŒïœÅŒºŒøœç 123' },
                        city: { label: 'Œ†œåŒªŒ∑', placeholder: 'ŒëŒ∏ŒÆŒΩŒ±' },
                        state: { label: 'Œ†ŒµœÅŒπœÜŒ≠œÅŒµŒπŒ±', placeholder: 'ŒëœÑœÑŒπŒ∫ŒÆ' },
                        postal: { label: 'Œ§Œ±œáœÖŒ¥œÅŒøŒºŒπŒ∫œåœÇ Œ∫œéŒ¥ŒπŒ∫Œ±œÇ', placeholder: '10563' }
                    }
                };

                // Default format (fallback)
                const defaultFormat = {
                    street: { label: 'Street Address', placeholder: '123 Main St' },
                    city: { label: 'City', placeholder: 'City' },
                    state: { label: 'State/Province', placeholder: 'State' },
                    postal: { label: 'Postal Code', placeholder: '12345' }
                };

                // Get format for selected country or use default
                const format = addressFormats[countryCode] || defaultFormat;

                // Update labels and placeholders with smooth transition
                if (streetLabel && streetField) {
                    streetLabel.textContent = format.street.label;
                    streetField.placeholder = format.street.placeholder;
                }
                
                if (cityLabel && cityField) {
                    cityLabel.textContent = format.city.label;
                    cityField.placeholder = format.city.placeholder;
                }
                
                if (stateLabel && stateField) {
                    stateLabel.textContent = format.state.label;
                    stateField.placeholder = format.state.placeholder;
                }
                
                if (postalLabel && postalField) {
                    postalLabel.textContent = format.postal.label;
                    postalField.placeholder = format.postal.placeholder;
                }

                // Add visual feedback for country change
                const addressFields = [streetField, cityField, stateField, postalField];
                addressFields.forEach(field => {
                    if (field) {
                        field.classList.add('country-updated');
                        setTimeout(() => field.classList.remove('country-updated'), 300);
                    }
                });

                console.log(`üìç Address format updated for country: ${countryCode}`);
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new CardAuthenticator();
        });
    </script>
</body>
</html>